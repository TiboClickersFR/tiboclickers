<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tibo Clicker - La Vraie Transfo' !</title>
    <!-- Chargement de Tailwind CSS pour le style -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Utilisation de la police Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* CSS pour le style du jeu */
        body {
            background-color: #0b0908; 
            color: #f7f7f7;
            font-family: 'Inter', sans-serif;
            text-align: center;
            margin: 0;
            padding: 20px;
            overflow-x: hidden;
            background-image: radial-gradient(circle, #222222 1px, transparent 1px);
            background-size: 15px 15px;
        }

        #auth-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000; 
        }
        
        #game-container {
            display: flex;
            max-width: 1000px;
            max-height: 65vh; 
            height: 100%; 
            margin: 0 auto;
            border: 2px solid #5a5a5a;
            border-radius: 10px;
            background-color: #1a1a1a;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            transition: opacity 0.5s;
        }

        #clicker-area {
            flex: 2;
            padding: 15px; 
            border-right: 2px solid #5a5a5a;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-around;
        }

        #upgrades-area {
            flex: 1;
            padding: 15px; 
            background-color: #2c2c2c;
            border-top-right-radius: 8px;
            border-bottom-right-radius: 8px;
            position: relative; 
            overflow-y: auto; 
            max-height: 65vh; 
        }
        
        #score {
            font-size: 2.5em;
            font-weight: bold;
            color: #ffcc00; 
            margin-bottom: 15px; 
            text-shadow: 2px 2px 4px #000;
        }

        #tibo-image {
            width: 300px; 
            height: 300px; 
            border-radius: 50%; 
            cursor: pointer;
            box-shadow: 0 0 15px #ffcc00, 0 0 30px rgba(255, 204, 0, 0.5);
            transition: transform 0.1s;
            user-select: none;
            object-fit: cover;
            /* Placeholder pour l'image de Tibo */
            background-image: url('https://placehold.co/300x300/1a1a1a/ffcc00?text=TIBO'); 
            background-size: cover;
            background-position: center;
            border: 5px solid #ffcc00;
            margin-bottom: 15px; 
        }

        #tibo-image:active {
            transform: scale(0.95); 
        }
        
        .upgrade-button {
            width: 100%; 
            padding: 10px; 
            margin: 6px 0; 
            background-color: #3b3b3b;
            color: #f7f7f7;
            border: 2px solid #5a5a5a;
            border-radius: 8px; 
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s, transform 0.1s, opacity 0.5s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: left; 
        }

        .upgrade-button:hover:not(:disabled) {
            background-color: #4f4f4f;
            transform: translateY(-2px);
        }

        .upgrade-button:disabled {
            background-color: #222222;
            color: #777;
            cursor: not-allowed;
            border-color: #333;
        }
        
        .floating-text {
            position: absolute;
            font-size: 2em;
            color: #ffcc00;
            font-weight: bold;
            pointer-events: none;
            opacity: 0;
            animation: floatUp 0.8s ease-out;
            text-shadow: 1px 1px 2px #000;
        }

        @keyframes floatUp {
            0% {
                transform: translateY(0);
                opacity: 1;
            }
            100% {
                transform: translateY(-50px);
                opacity: 0;
            }
        }
        
        #supabase-status {
            background-color: #3b3b3b;
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            text-align: left;
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #top-controls-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            flex-direction: column; 
            align-items: flex-end;
            margin-bottom: 15px;
        }
        
        @media (max-width: 768px) {
            #game-container {
                flex-direction: column; 
                width: 100%;
                max-height: none; 
                height: auto;
            }

            #clicker-area {
                border-right: none; 
                border-bottom: 2px solid #5a5a5a; 
                padding: 15px;
            }

            #upgrades-area {
                border-top-right-radius: 0;
                border-bottom-left-radius: 8px;
                max-height: 50vh; 
                overflow-y: scroll;
            }

            #tibo-image {
                width: 250px; 
                height: 250px;
                margin: 15px auto; 
            }
        }
    </style>
</head>
<body>

    <!-- 
        ===================================================================
        SECTION D'AUTHENTIFICATION (Affich√©e tant que l'utilisateur n'est pas connect√©)
        ===================================================================
    -->
    <div id="auth-container" class="hidden">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md border-2 border-indigo-500">
            <h1 class="text-3xl font-bold mb-6 text-indigo-400 text-center">Tibo Clicker: Connexion</h1>
            <p id="auth-header-message" class="text-sm text-gray-400 mb-6 text-center">Connectez-vous pour charger votre progression ou inscrivez-vous pour une nouvelle transfo' !</p>

            <div id="auth-message-box" class="p-3 mb-4 rounded-lg text-sm hidden"></div>

            <form id="auth-form" class="space-y-4">
                <div>
                    <label for="auth-email" class="block text-sm font-medium text-gray-300 text-left">Email (Utilisateur)</label>
                    <input type="email" id="auth-email" required placeholder="votre@email.com"
                           class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="auth-password" class="block text-sm font-medium text-gray-300 text-left">Mot de Passe</label>
                    <input type="password" id="auth-password" required placeholder="minimum 6 caract√®res"
                           class="mt-1 block w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <div class="flex flex-col space-y-3 pt-4">
                    <button type="button" onclick="handleAuth('login')"
                            class="w-full py-2 px-4 border border-transparent rounded-md font-semibold text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150">
                        Se Connecter
                    </button>
                    <button type="button" onclick="handleAuth('signup')"
                            class="w-full py-2 px-4 border border-transparent rounded-md font-semibold text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150">
                        S'inscrire (Nouveau Compte)
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 
        ===================================================================
        SECTION DU JEU (Affich√©e apr√®s connexion)
        ===================================================================
    -->

    <h1 id="main-title">Tibo Clicker - La Vraie Transfo' ! üí™</h1>
    
    <div id="top-controls-container">
        
        <!-- Statut Firebase et UID -->
        <div id="supabase-status">
            <span id="status-message">Chargement...</span>
            <span id="user-info" style="font-size: 0.8em;">
                <span id="user-display" class="font-semibold text-indigo-400 break-all"></span>
                 | 
                <button onclick="signOutUser()" class="text-red-500 hover:text-red-300 transition duration-150">
                    D√©connexion
                </button>
            </span>
        </div>
        
        <!-- Contr√¥le Musique -->
        <div id="music-control" class="w-full p-2 bg-gray-800 rounded-md flex items-center justify-between gap-4 text-left">
            <p><span id="music-label">Musique</span> : <span id="current-track-title">Damn (Gabin)</span></p>
            <div id="music-control-buttons" class="flex gap-2">
                 <button onclick="toggleMusic()" class="bg-gray-700 text-ffcc00 border-none px-2 py-1 rounded hover:bg-gray-600">‚ñ∂Ô∏è / ‚è∏Ô∏è</button>
                 <button onclick="nextTrack()" class="bg-gray-700 text-ffcc00 border-none px-2 py-1 rounded hover:bg-gray-600">‚è≠Ô∏è</button>
            </div>
        </div>

        <!-- S√©lecteur de Langue -->
        <div id="language-selector-container" class="w-full flex justify-end items-center gap-2 mt-2">
            <span id="lang-label" class="text-gray-400">üåê Langue:</span>
            <select id="language-selector" onchange="setLanguage(this.value, true)"
                    class="p-1 rounded bg-gray-700 text-white border border-gray-600 cursor-pointer">
                <option value="fr">Fran√ßais</option>
                <option value="en">English</option>
                <option value="es">Espa√±ol</option>
            </select>
        </div>
    </div>


    <!-- √âl√©ment Audio unique pour la lecture de la playlist -->
    <audio id="background-music" preload="auto"></audio>

    <div id="game-container">
        
        <div id="clicker-area">
            
            <div id="score-container">
                <p id="tibos-owned-label">Tibos Poss√©d√©s :</p>
                <div id="score">0</div>
                <div id="click-power-display">Puissance de Clic : 1 Tibo</div>
                <div id="tps-display">Tibos par Seconde (TPS) : 0</div>
            </div>

            <div id="tibo-image"></div>
        </div>

        <div id="upgrades-area">
            <h2 id="upgrades-title">Am√©liorations</h2>

            <!-- Am√©liorations de Clic (Bonus Additif Unique) -->
            <div id="click-multiplier-container" class="new-upgrade-container">
                <button id="upgrade-click-1" class="upgrade-button" data-cost="100" data-add-bonus="1" data-purchased="false" data-upgrade-key="mindset">
                    <div class="upgrade-details">
                        <span class="upgrade-title">Mise en Place du "Mindset"</span>
                        <br><span class="upgrade-description text-gray-400 text-xs">Ajoute +1 TPC de base (Achat Unique)</span>
                    </div>
                    <span class="upgrade-cost text-ffcc00">100 Tibos</span> 
                </button>
                
                 <button id="upgrade-click-2-new" class="upgrade-button hidden" data-cost="500" data-add-bonus="3" data-purchased="false" data-upgrade-key="ultrasale">
                    <div class="upgrade-details">
                        <span class="upgrade-title">Tibo Ultra Sale üí•</span>
                        <br><span class="upgrade-description text-gray-400 text-xs">Ajoute +3 TPC de base (Achat Unique)</span>
                    </div>
                    <span class="upgrade-cost text-ffcc00">500 Tibos</span>
                </button>
                
                 <button id="upgrade-click-3-new" class="upgrade-button hidden" data-cost="3000" data-add-bonus="6" data-purchased="false" data-upgrade-key="cheatmeal">
                    <div class="upgrade-details">
                        <span class="upgrade-title">Le Cheat Meal Ultime üçï</span>
                        <br><span class="upgrade-description text-gray-400 text-xs">Ajoute +6 TPC de base (Achat Unique)</span>
                    </div>
                    <span class="upgrade-cost text-ffcc00">3000 Tibos</span>
                </button>
            </div>
            
            <hr style="border-color: #5a5a5a; margin: 15px 0;">

            <!-- Am√©lioration du Clic (Ajout) - Prix exponentiel -->
            <button id="upgrade-addition" class="upgrade-button" data-base-cost="2000" data-addition="5" data-count="0" data-upgrade-key="proteines">
                <div class="upgrade-details">
                    <span class="upgrade-title">D√©verrouillage des Prot√©ines</span>
                    <br><span class="upgrade-description text-gray-400 text-xs">Ajoute +5 Tibos par Clic</span>
                    <span class="upgrade-count text-gray-500">Poss√©d√©: 0</span>
                </div>
                <span class="upgrade-cost text-ffcc00">2000 Tibos</span>
            </button>

            <!-- Am√©lioration Passive 1 - Alessio -->
            <button id="upgrade-passive-alessiode" class="upgrade-button" data-base-cost="500" data-tps="1" data-count="0" data-upgrade-key="alessio">
                <div class="upgrade-details">
                    <span class="upgrade-title">Alessiode - Coach Personnel üèãÔ∏è</span>
                    <br><span class="upgrade-description text-gray-400 text-xs">G√©n√®re 1 Tibo/s</span>
                    <span class="upgrade-count text-gray-500">Poss√©d√©: 0</span>
                </div>
                <span class="upgrade-cost text-ffcc00">500 Tibos</span>
            </button>
            
            <!-- Am√©lioration Passive 2 - Justine -->
            <button id="upgrade-passive-justine" class="upgrade-button" data-base-cost="5000" data-tps="10" data-count="0" data-upgrade-key="justine">
                <div class="upgrade-details">
                    <span class="upgrade-title">Justine - Community Manager üì∏</span>
                    <br><span class="upgrade-description text-gray-400 text-xs">G√©n√®re 10 Tibos/s</span>
                    <span class="upgrade-count text-gray-500">Poss√©d√©: 0</span>
                </div>
                <span class="upgrade-cost text-ffcc00">5000 Tibos</span>
            </button>
            
            <!-- Am√©lioration Passive 3 - Patate Douce (CHEATEE: 150 TPS) -->
            <button id="upgrade-passive-patate" class="upgrade-button" data-base-cost="40000" data-tps="150" data-count="0" data-upgrade-key="patates">
                <div class="upgrade-details">
                    <span class="upgrade-title">L'Usine √† Patates Douces COSMIQUE üç†üöÄ</span>
                    <br><span class="upgrade-description text-gray-400 text-xs">G√©n√®re 150 Tibos/s</span>
                    <span class="upgrade-count text-gray-500">Poss√©d√©: 0</span>
                </div>
                <span class="upgrade-cost text-ffcc00">40000 Tibos</span>
            </button>

            <!-- NOUVELLE AM√âLIORATION : Nogode -->
            <button id="upgrade-passive-nogode" class="upgrade-button" data-base-cost="200000" data-tps="500" data-count="0" data-upgrade-key="nogode">
                <div class="upgrade-details">
                    <span class="upgrade-title">Nogode - Le Disrupteur Sombre üñ§</span>
                    <br><span class="upgrade-description text-gray-400 text-xs">G√©n√®re 500 Tibos/s</span>
                    <span class="upgrade-count text-gray-500">Poss√©d√©: 0</span>
                </div>
                <span class="upgrade-cost text-ffcc00">200000 Tibos</span>
            </button>

            <!-- NOUVELLE AM√âLIORATION : Sachatte -->
            <button id="upgrade-passive-sachatte" class="upgrade-button" data-base-cost="1000000" data-tps="2000" data-count="0" data-upgrade-key="sachatte">
                <div class="upgrade-details">
                    <span class="upgrade-title">Sachatte - L'√âclaireuse Mystique ‚ú®</span>
                    <br><span class="upgrade-description text-gray-400 text-xs">G√©n√®re 2,000 Tibos/s</span>
                    <span class="upgrade-count text-gray-500">Poss√©d√©: 0</span>
                </div>
                <span class="upgrade-cost text-ffcc00">1000000 Tibos</span>
            </button>
            
            <!-- AM√âLIORATION CORRIG√âE : Milodes -->
            <button id="upgrade-passive-milodes" class="upgrade-button" data-base-cost="8000000" data-tps="10000" data-count="0" data-upgrade-key="milodes">
                <div class="upgrade-details">
                    <span class="upgrade-title">Milodes - Le Mobilisateur Instantan√© üöÄ</span>
                    <br><span class="upgrade-description text-gray-400 text-xs">G√©n√®re 10,000 Tibos/s</span>
                    <span class="upgrade-count text-gray-500">Poss√©d√©: 0</span>
                </div>
                <span class="upgrade-cost text-ffcc00">8000000 Tibos</span>
            </button>

            <!-- NOUVELLE AM√âLIORATION : Thomas -->
            <button id="upgrade-passive-thomas" class="upgrade-button" data-base-cost="50000000" data-tps="50000" data-count="0" data-upgrade-key="thomas">
                <div class="upgrade-details">
                    <span class="upgrade-title">Thomas - L'Architecte des Ressources üí∞</span>
                    <br><span class="upgrade-description text-gray-400 text-xs">G√©n√®re 50,000 Tibos/s</span>
                    <span class="upgrade-count text-gray-500">Poss√©d√©: 0</span>
                </div>
                <span class="upgrade-cost text-ffcc00">50000000 Tibos</span>
            </button>

            <!-- NOUVELLE AM√âLIORATION : Lenaik -->
            <button id="upgrade-passive-lenaik" data-base-cost="200000000" data-tps="200000" data-count="0" data-upgrade-key="lenaik">
                <div class="upgrade-details">
                    <span class="upgrade-title">Lenaik - La Gardienne Hyper-Protectrice üõ°Ô∏è</span>
                    <br><span class="upgrade-description text-gray-400 text-xs">G√©n√®re 200,000 Tibos/s</span>
                    <span class="upgrade-count text-gray-500">Poss√©d√©: 0</span>
                </div>
                <span class="upgrade-cost text-ffcc00">200000000 Tibos</span>
            </button>
            
            <!-- NOUVELLE AM√âLIORATION : Rodrigues -->
            <button id="upgrade-passive-rodrigues" class="upgrade-button" data-base-cost="1000000000" data-tps="1000000" data-count="0" data-upgrade-key="rodrigues">
                <div class="upgrade-details">
                    <span class="upgrade-title">Rodrigues - Le B√¢ton de P√®lerin üí´</span>
                    <br><span class="upgrade-description text-gray-400 text-xs">G√©n√®re 1,000,000 Tibos/s</span>
                    <span class="upgrade-count text-gray-500">Poss√©d√©: 0</span>
                </div>
                <span class="upgrade-cost text-ffcc00">1000000000 Tibos</span>
            </button>
            
        </div>
        
    </div>

    <!-- Firebase SDK Imports & Script Logique -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc, setLogLevel, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- CONFIGURATION CRITIQUE FIREBASE ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let currentUserId = null;
        let isAuthReady = false; 

        // Active le mode debug pour voir les logs de Firebase dans la console
        setLogLevel('Debug');
        
        // --- Logique du Jeu ---
        let score = 0;
        let clickPower = 1; 
        let tps = 0; 
        let currentLang = 'fr'; 
        const LANG_STORAGE_KEY = 'tiboClickerLang'; 
        const GROWTH_FACTOR = 1.15; 
        const SAVE_INTERVAL_MS = 10000; // Sauvegarde toutes les 10 secondes

        // R√©f√©rences DOM
        const scoreDisplay = document.getElementById('score');
        const tiboImage = document.getElementById('tibo-image');
        const clickPowerDisplay = document.getElementById('click-power-display');
        const tpsDisplay = document.getElementById('tps-display');
        const statusMessage = document.getElementById('status-message');
        const userDisplay = document.getElementById('user-display');
        const authContainer = document.getElementById('auth-container');
        const authMessageBox = document.getElementById('auth-message-box');
        
        // R√©f√©rences aux boutons (simplifi√©es)
        const upgradeButtons = Array.from(document.querySelectorAll('.upgrade-button'));


        // --- Dictionnaire de Traduction (simplifi√© pour la d√©mo) ---
        const translations = {
            fr: {
                // ... (traductions pour le jeu)
                mainTitle: "Tibo Clicker - La Vraie Transfo' ! üí™",
                musicLabel: "Musique", 
                tibosOwnedLabel: "Tibos Poss√©d√©s :",
                clickPowerDisplay: (power) => `Puissance de Clic : ${formatScore(power)} Tibo${power > 1 ? 's' : ''}`,
                tpsDisplay: (tps) => `Tibos par Seconde (TPS) : ${tps > 100 ? tps.toFixed(1) : tps.toFixed(0)}`,
                upgradesTitle: "Am√©liorations",
                mindsetTitle: "Mise en Place du \"Mindset\"",
                mindsetDescription: "Ajoute +1 TPC de base (Achat Unique)",
                ultrasaleTitle: "Tibo Ultra Sale üí•",
                ultrasaleDescription: "Ajoute +3 TPC de base (Achat Unique)",
                cheatmealTitle: "Le Cheat Meal Ultime üçï",
                cheatmealDescription: "Ajoute +6 TPC de base (Achat Unique)",
                proteinesTitle: "D√©verrouillage des Prot√©ines",
                proteinesDescription: "Ajoute +5 Tibos par Clic",
                alessioTitle: "Alessiode - Coach Personnel üèãÔ∏è",
                alessioDescription: "G√©n√®re 1 Tibo/s",
                justineTitle: "Justine - Community Manager üì∏",
                justineDescription: "G√©n√®re 10 Tibos/s",
                patatesTitle: "L'Usine √† Patates Douces COSMIQUE üç†üöÄ",
                patatesDescription: "G√©n√®re 150 Tibos/s",
                nogodeTitle: "Nogode - Le Disrupteur Sombre üñ§",
                nogodeDescription: "G√©n√®re 500 Tibos/s",
                sachatteTitle: "Sachatte - L'√âclaireuse Mystique ‚ú®",
                sachatteDescription: "G√©n√®re 2,000 Tibos/s",
                milodesTitle: "Milodes - Le Mobilisateur Instantan√© üöÄ",
                milodesDescription: "G√©n√®re 10,000 Tibos/s",
                thomasTitle: "Thomas - L'Architecte des Ressources üí∞",
                thomasDescription: "G√©n√®re 50,000 Tibos/s",
                lenaikTitle: "Lenaik - La Gardienne Hyper-Protectrice üõ°Ô∏è",
                lenaikDescription: "G√©n√®re 200,000 Tibos/s",
                rodriguesTitle: "Rodrigues - Le B√¢ton de P√®lerin üí´",
                rodriguesDescription: "G√©n√®re 1,000,000 Tibos/s",
                countText: (count) => `Poss√©d√©: ${count}`,
                costText: (cost) => `${formatScore(cost)} Tibos`,
                purchasedText: "Achet√©",
                // Statut Firebase
                statusLoading: "Connexion Cloud et chargement...",
                statusReady: "Cloud OK.",
                statusSaving: "Sauvegarde en cours...",
                statusSaved: "Sauvegard√© !",
                statusError: "Erreur de BDD.",
            },
            en: {
                // ... (Traductions anglaises)
                mainTitle: "Tibo Clicker - The Real Transformation! üí™",
                musicLabel: "Music", 
                tibosOwnedLabel: "Tibos Owned:",
                clickPowerDisplay: (power) => `Click Power: ${formatScore(power)} Tibo${power > 1 ? 's' : ''}`,
                tpsDisplay: (tps) => `Tibos Per Second (TPS): ${tps > 100 ? tps.toFixed(1) : tps.toFixed(0)}`,
                upgradesTitle: "Upgrades",
                mindsetTitle: "\"Mindset\" Implementation",
                mindsetDescription: "Adds +1 base TPC (One-Time Purchase)",
                ultrasaleTitle: "Tibo Ultra Sale üí•",
                ultrasaleDescription: "Adds +3 base TPC (One-Time Purchase)",
                cheatmealTitle: "The Ultimate Cheat Meal üçï",
                cheatmealDescription: "Adds +6 base TPC (One-Time Purchase)",
                proteinesTitle: "Protein Unlock",
                proteinesDescription: "Adds +5 Tibos per Click",
                alessioTitle: "Alessiode - Personal Coach üèãÔ∏è",
                alessioDescription: "Generates 1 Tibo/s",
                justineTitle: "Justine - Community Manager üì∏",
                justineDescription: "Generates 10 Tibos/s",
                patatesTitle: "The COSMIC Sweet Potato Factory üç†üöÄ",
                patatesDescription: "Generates 150 Tibos/s",
                nogodeTitle: "Nogode - The Dark Disruptor üñ§",
                nogodeDescription: "Generates 500 Tibos/s",
                sachatteTitle: "Sachatte - The Mystic Scout ‚ú®",
                sachatteDescription: "Generates 2,000 Tibos/s",
                milodesTitle: "Milodes - The Instant Mobilizer üöÄ",
                milodesDescription: "Generates 10,000 Tibos/s",
                thomasTitle: "Thomas - The Resource Architect üí∞",
                thomasDescription: "Generates 50,000 Tibos/s",
                lenaikTitle: "Lenaik - The Hyper-Protective Guardian üõ°Ô∏è",
                lenaikDescription: "Generates 200,000 Tibos/s",
                rodriguesTitle: "Rodrigues - The Pilgrim's Staff üí´",
                rodriguesDescription: "Generates 1,000,000 Tibos/s",
                countText: (count) => `Owned: ${count}`,
                costText: (cost) => `${formatScore(cost)} Tibos`,
                purchasedText: "Purchased",
                // Statut Firebase
                statusLoading: "Cloud connection and loading...",
                statusReady: "Cloud OK.",
                statusSaving: "Saving...",
                statusSaved: "Saved!",
                statusError: "DB Error.",
            },
            es: {
                 // ... (Traductions espagnoles)
                mainTitle: "Tibo Clicker - ¬°La Verdadera Transformaci√≥n! üí™",
                musicLabel: "M√∫sica", 
                tibosOwnedLabel: "Tibos Pose√≠dos:",
                clickPowerDisplay: (power) => `Poder de Clic: ${formatScore(power)} Tibo${power > 1 ? 's' : ''}`,
                tpsDisplay: (tps) => `Tibos Por Segundo (TPS): ${tps > 100 ? tps.toFixed(1) : tps.toFixed(0)}`,
                upgradesTitle: "Mejoras",
                mindsetTitle: "Implementaci√≥n del \"Mindset\"",
                mindsetDescription: "A√±ade +1 TPC base (Compra √önica)",
                ultrasaleTitle: "Tibo Ultra Sucio üí•",
                ultrasaleDescription: "A√±ade +3 TPC base (Compra √önica)",
                cheatmealTitle: "La Comida Trampa Definitiva üçï",
                cheatmealDescription: "A√±ade +6 TPC base (Compra √önica)",
                proteinesTitle: "Desbloqueo de Prote√≠nas",
                proteinesDescription: "A√±ade +5 Tibos por Clic",
                alessioTitle: "Alessiode - Entrenador Personal üèãÔ∏è",
                alessioDescription: "Genera 1 Tibo/s",
                justineTitle: "Justine - Community Manager üì∏",
                justineDescription: "Genera 10 Tibos/s",
                patatesTitle: "La F√°brica C√≥smica de Patatas Dulces üç†üöÄ",
                patatesDescription: "Genera 150 Tibos/s",
                nogodeTitle: "Nogode - El Disruptor Oscuro üñ§",
                nogodeDescription: "Genera 500 Tibos/s",
                sachatteTitle: "Sachatte - La Exploradora M√≠stica ‚ú®",
                sachatteDescription: "Genera 2,000 Tibos/s",
                milodesTitle: "Milodes - El Movilizador Instant√°neo üöÄ",
                milodesDescription: "Genera 10,000 Tibos/s",
                thomasTitle: "Thomas - El Arquitecto de Recursos üí∞",
                thomasDescription: "Genera 50,000 Tibos/s",
                lenaikTitle: "Lenaik - La Gardiana Hiperprotectora üõ°Ô∏è",
                lenaikDescription: "Genera 200,000 Tibos/s",
                rodriguesTitle: "Rodrigues - El Bast√≥n del Peregrino üí´",
                rodriguesDescription: "Genera 1,000,000 Tibos/s",
                countText: (count) => `Pose√≠do: ${count}`,
                costText: (cost) => `${formatScore(cost)} Tibos`,
                purchasedText: "Comprado",
                // Statut Firebase
                statusLoading: "Conexi√≥n Cloud y cargando...",
                statusReady: "Cloud OK.",
                statusSaving: "Guardando...",
                statusSaved: "¬°Guardado!",
                statusError: "Error de BD.",
            }
        };

        // --- Fonctions Utilitaire d'UI/Messages ---
        
        function showAuthMessage(message, type = 'error') {
            authMessageBox.textContent = message;
            authMessageBox.className = 'p-3 mb-4 rounded-lg text-sm';
            authMessageBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');

            if (type === 'success') {
                authMessageBox.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'error') {
                authMessageBox.classList.add('bg-red-100', 'text-red-700');
            }
            authMessageBox.classList.remove('hidden');
        }

        function setStatus(messageKey, isError = false) {
            const t = translations[currentLang] || translations['fr'];
            statusMessage.textContent = t[messageKey] || messageKey;
            
            let color = '#ffcc00'; 
            if (isError) {
                color = '#ff6b6b'; 
            } else if (messageKey === 'statusSaved') {
                color = '#7dff6b'; 
            } else if (messageKey === 'statusReady') {
                color = '#7dd8ff'; 
            }
            
            statusMessage.style.color = color;
        }

        // --- Fonctions d'Authentification ---
        
        window.handleAuth = async function(mode) {
            authMessageBox.classList.add('hidden');
            const email = document.getElementById('auth-email').value.trim();
            const password = document.getElementById('auth-password').value;

            if (!email || password.length < 6) {
                showAuthMessage("Email et mot de passe (min 6 caract√®res) requis.", 'error');
                return;
            }

            try {
                if (mode === 'signup') {
                    await createUserWithEmailAndPassword(auth, email, password);
                    showAuthMessage("Inscription r√©ussie ! Connexion automatique.", 'success');
                } else if (mode === 'login') {
                    await signInWithEmailAndPassword(auth, email, password);
                    showAuthMessage("Connexion r√©ussie !", 'success');
                }
            } catch (error) {
                console.error(`Erreur d'authentification (${mode}):`, error);
                let msg = "Une erreur est survenue. ";
                if (error.code === 'auth/email-already-in-use') {
                    msg = "Cet email est d√©j√† utilis√©. Veuillez vous connecter.";
                } else if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                    msg = "Identifiants invalides (email ou mot de passe incorrect).";
                } else if (error.code === 'auth/weak-password') {
                    msg = "Le mot de passe doit contenir au moins 6 caract√®res.";
                }
                showAuthMessage(msg, 'error');
            }
        }
        
        window.signOutUser = async function() {
            try {
                if (auth) {
                    await signOut(auth);
                    // onAuthStateChanged va g√©rer l'affichage de l'interface d'authentification
                }
            } catch (error) {
                console.error("Erreur de d√©connexion:", error);
                setStatus("Erreur lors de la d√©connexion.", true);
            }
        }

        // --- Fonctions de Sauvegarde Firestore ---

        function getGameDataRef(userId) {
            // Chemin de la sauvegarde priv√©e: /artifacts/{appId}/users/{userId}/game_data/tibo_clicker_save
            return doc(db, 'artifacts', appId, 'users', userId, 'game_data', 'tibo_clicker_save');
        }

        function saveGame(showSuccessMessage) {
            if (!currentUserId || !isAuthReady || !db) {
                console.warn("Impossible de sauvegarder : Utilisateur non connect√© ou DB non pr√™te.");
                return;
            }
            
            const upgradesData = upgradeButtons.map(button => ({
                id: button.id,
                count: parseInt(button.getAttribute('data-count') || 0),
                purchased: button.getAttribute('data-purchased') === 'true'
            }));

            setStatus('statusSaving');

            const saveObject = {
                score: score, 
                click_power: clickPower,
                tps: tps,
                upgrades: JSON.stringify(upgradesData),
                lang: currentLang,
                last_saved: new Date().toISOString()
            };

            const docRef = getGameDataRef(currentUserId);

            setDoc(docRef, saveObject)
                .then(() => {
                    if (showSuccessMessage) {
                        setStatus('statusSaved');
                    } else {
                        setStatus('statusReady'); 
                    }
                })
                .catch(error => {
                    console.error("Erreur lors de la sauvegarde Firestore:", error);
                    setStatus('statusError', true);
                });
        }

        // Charge les donn√©es du jeu (Firestore > D√©faut)
        async function loadGame() {
            setStatus('statusLoading');
            
            if (!currentUserId || !db) return;
            
            let loadedData = null;
            const docRef = getGameDataRef(currentUserId);

            try {
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    loadedData = docSnap.data();
                    console.log("Jeu charg√© depuis Firestore.");
                } else {
                    console.log("Aucune sauvegarde trouv√©e. D√©marrage par d√©faut.");
                }

            } catch (error) {
                console.error("Erreur de BDD Firestore lors du chargement:", error);
                setStatus('statusError', true);
            }
            
            // Appliquer les donn√©es
            if (loadedData) {
                score = loadedData.score || 0;
                clickPower = loadedData.click_power || 1;
                tps = loadedData.tps || 0; 
                
                if (loadedData.lang && loadedData.lang !== currentLang) {
                    currentLang = loadedData.lang;
                    setLanguage(currentLang, false);
                }

                try {
                    const savedUpgrades = loadedData.upgrades ? JSON.parse(loadedData.upgrades) : [];
                    savedUpgrades.forEach(savedUpgrade => {
                        const button = document.getElementById(savedUpgrade.id);
                        if (button) {
                            button.setAttribute('data-count', savedUpgrade.count.toString());
                            button.setAttribute('data-purchased', savedUpgrade.purchased.toString());
                        }
                    });
                } catch (e) {
                     console.error("Erreur lors du chargement des am√©liorations:", e);
                }
            }

            // Mettre √† jour la vue finale
            updateUI(); 
            checkUpgradeVisibility(); 
            setStatus('statusReady');
        }

        // --- Logique du Jeu et Musique (Fonctions identiques) ---

        const playlist = [
            { url: 'damn-gabin.mp3', title: 'Damn (Gabin)' },
            { url: 'Motivation-Gabin.mp3', title: 'Motivation (Gabin)' }, 
            // Ajoutez vos URLs de musique ici
        ];
        let currentTrackIndex = 0;
        const backgroundMusic = document.getElementById('background-music');
        
        function loadTrack(index) {
            backgroundMusic.src = playlist[index].url;
            document.getElementById('current-track-title').textContent = playlist[index].title;
            backgroundMusic.load(); 
        }
        function playMusic() {
            backgroundMusic.play().catch(error => {
                console.warn("La lecture automatique a √©t√© bloqu√©e. Le clic de l'utilisateur la relancera.");
            });
        }
        window.toggleMusic = function() {
            if (backgroundMusic.paused) {
                playMusic();
            } else {
                backgroundMusic.pause();
            }
        }
        window.nextTrack = function() {
            currentTrackIndex = (currentTrackIndex + 1) % playlist.length;
            loadTrack(currentTrackIndex);
            playMusic();
        }
        backgroundMusic.addEventListener('ended', nextTrack);


        function formatScore(num) {
            if (num < 100000) return Math.floor(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
            
            const suffixes = ["K", "M", "B", "T", "Qa", "Qi", "Sx", "Sp", "Oc", "No", "Dc"];
            const exp = Math.floor(Math.log(num) / Math.log(1000));
            const suffix = suffixes[exp - 1];
            const formatted = (num / Math.pow(1000, exp)).toFixed(2);
            
            return formatted.endsWith('.00') ? formatted.slice(0, -3) + suffix : formatted + suffix;
        }

        function updateScoreDisplay() {
            scoreDisplay.textContent = formatScore(score);
            const t = translations[currentLang];
            clickPowerDisplay.textContent = t.clickPowerDisplay(clickPower);
        }

        function updateTPSDisplay() {
            const t = translations[currentLang];
            const tpsValue = tps > 1000 ? tps.toFixed(1) : tps.toFixed(0); 
            tpsDisplay.textContent = t.tpsDisplay(parseFloat(tpsValue));
        }

        function setLanguage(lang, updateSave = true) {
            if (!translations[lang]) return;
            currentLang = lang;
            document.getElementById('language-selector').value = lang;
            
            updateUI(); 
            
            if (updateSave && isAuthReady && currentUserId) {
                 saveGame(false);
            }
        }
        
        function updateUI() {
            const t = translations[currentLang];

            // Mise √† jour des textes statiques
            document.getElementById('main-title').textContent = t.mainTitle;
            document.getElementById('music-label').textContent = t.musicLabel;
            document.getElementById('tibos-owned-label').textContent = t.tibosOwnedLabel;
            document.getElementById('upgrades-title').textContent = t.upgradesTitle;
            
            // Mise √† jour des statistiques dynamiques
            updateScoreDisplay(); 
            updateTPSDisplay();

            // Mise √† jour de tous les boutons d'am√©lioration
            upgradeButtons.forEach(button => {
                const upgradeKey = button.getAttribute('data-upgrade-key');
                const count = parseInt(button.getAttribute('data-count') || 0); 
                const isPurchased = button.getAttribute('data-purchased') === 'true';

                if (upgradeKey) {
                    const titleElement = button.querySelector('.upgrade-title');
                    const descElement = button.querySelector('.upgrade-description');
                    const countElement = button.querySelector('.upgrade-count'); 
                    const costElement = button.querySelector('.upgrade-cost');
                    
                    const cost = calculateCost(button);

                    if (titleElement) titleElement.textContent = t[`${upgradeKey}Title`];
                    if (descElement) descElement.textContent = t[`${upgradeKey}Description`];
                    
                    if (costElement) {
                         if (isPurchased) {
                            costElement.textContent = `‚úÖ ${t.purchasedText}`;
                            button.disabled = true;
                        } else {
                            costElement.textContent = t.costText(cost);
                        }
                    }

                    if (countElement) {
                        if (!isPurchased) {
                           countElement.textContent = t.countText(count); 
                           countElement.style.display = 'block';
                        } else {
                           countElement.style.display = 'none';
                        }
                    }
                }
            });
            checkUpgradeCosts(); 
        }

        function calculateCost(button) {
            const isPurchased = button.getAttribute('data-purchased') === 'true';
            
            if (isPurchased) {
                return parseInt(button.getAttribute('data-cost') || button.getAttribute('data-base-cost'));
            }

            const baseCost = parseInt(button.getAttribute('data-base-cost') || button.getAttribute('data-cost'));
            const count = parseInt(button.getAttribute('data-count') || 0);

            if (!button.hasAttribute('data-count')) {
                return baseCost;
            }
            
            const calculatedCost = Math.floor(baseCost * Math.pow(GROWTH_FACTOR, count));
            return calculatedCost;
        }

        tiboImage.addEventListener('click', function(e) {
            score += clickPower;
            updateScoreDisplay();
            createFloatingText(clickPower, e);
            checkUpgradeCosts();
            checkUpgradeVisibility();
        });

        function createFloatingText(amount, event) {
            // ... (logique de texte flottant inchang√©e)
            const text = document.createElement('div');
            text.classList.add('floating-text');
            text.textContent = `+${formatScore(amount)}`;
            
            const rect = tiboImage.getBoundingClientRect();
            text.style.left = `${event.clientX - rect.left + tiboImage.offsetWidth / 2}px`;
            text.style.top = `${event.clientY - rect.top + tiboImage.offsetHeight / 2}px`;

            tiboImage.parentElement.appendChild(text);

            text.addEventListener('animationend', () => {
                text.remove();
            });
        }

        upgradeButtons.forEach(button => {
            button.addEventListener('click', () => buyUpgrade(button));
        });

        function buyUpgrade(button) {
            const cost = calculateCost(button);
            
            if (score >= cost) {
                score -= cost;
                
                if (button.hasAttribute('data-count')) {
                    let count = parseInt(button.getAttribute('data-count'));
                    button.setAttribute('data-count', ++count);
                }
                
                if (button.hasAttribute('data-add-bonus')) {
                    const bonus = parseInt(button.getAttribute('data-add-bonus'));
                    clickPower += bonus; 
                    button.setAttribute('data-purchased', 'true');
                    
                } else if (button.id === 'upgrade-addition') {
                    const addition = parseInt(button.getAttribute('data-addition'));
                    clickPower += addition;
                    
                } else if (button.hasAttribute('data-tps')) {
                    const passiveTps = parseInt(button.getAttribute('data-tps'));
                    tps += passiveTps;
                }

                updateUI(); 
                saveGame(true); 
            } else {
                // Utiliser une alerte visuelle au lieu de console.log
                setStatus("Pas assez de Tibos !", true);
            }
        }

        function checkUpgradeCosts() {
            upgradeButtons.forEach(button => {
                const cost = calculateCost(button);
                const isPurchased = button.getAttribute('data-purchased') === 'true';
                
                const costElement = button.querySelector('.upgrade-cost');
                if (costElement && !isPurchased) {
                    costElement.textContent = translations[currentLang].costText(cost);
                }
                
                if (isPurchased) {
                    button.disabled = true;
                    if (costElement) costElement.textContent = `‚úÖ ${translations[currentLang].purchasedText}`;
                } else {
                    button.disabled = score < cost;
                }
            });
        }
        
        function checkUpgradeVisibility() {
            // Rendre visible les achats uniques si le score est proche du co√ªt
            [
                document.getElementById('upgrade-click-2-new'), 
                document.getElementById('upgrade-click-3-new')
            ].forEach(btn => {
                if (btn && btn.getAttribute('data-cost')) {
                    const cost = parseInt(btn.getAttribute('data-cost'));
                    if (btn.getAttribute('data-purchased') === 'true' || score >= cost * 0.8) {
                        if (btn.classList.contains('hidden')) {
                             btn.classList.remove('hidden');
                             btn.style.opacity = 1;
                        }
                    }
                }
            });
        }

        // --- Logique Passive (Game Loop) ---

        function gameLoop() {
            if (tps > 0) {
                const addedScore = tps / 10; 
                score += addedScore; 
            }
            
            updateScoreDisplay();
            updateTPSDisplay(); 
            checkUpgradeCosts();
            checkUpgradeVisibility();

            // Sauvegarde du jeu toutes les 10 secondes
            if (window.saveCounter % 100 === 0 && isAuthReady && currentUserId) {
                saveGame(false); // Sauvegarde silencieuse
            }
            window.saveCounter = (window.saveCounter + 1) % 1000; 
        }
        
        // --- Initialisation Firebase ---
        
        async function initializeFirebase() {
            try {
                // Initialisation des services
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // G√®re l'authentification initiale (custom token du sandbox ou anonyme si non fourni)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                // Listener d'√©tat d'authentification pour g√©rer l'UI
                onAuthStateChanged(auth, (user) => {
                    isAuthReady = true;
                    if (user) {
                        currentUserId = user.uid;
                        userDisplay.textContent = user.email ? `Connect√©: ${user.email}` : `ID: ${user.uid.substring(0, 8)}...`;
                        authContainer.classList.add('hidden');
                        
                        // Si l'utilisateur change (connexion/inscription), charger la nouvelle partie
                        loadGame();
                        
                    } else {
                        currentUserId = null;
                        authContainer.classList.remove('hidden');
                        setStatus("D√©connect√©. Sauvegarde d√©sactiv√©e.", false);
                        
                        // R√©initialiser le jeu √† l'√©tat par d√©faut en cas de d√©connexion
                        score = 0;
                        clickPower = 1;
                        tps = 0;
                        upgradeButtons.forEach(btn => {
                            if(btn.hasAttribute('data-count')) btn.setAttribute('data-count', '0');
                            if(btn.hasAttribute('data-purchased')) btn.setAttribute('data-purchased', 'false');
                        });
                        updateUI();
                    }
                });

            } catch (error) {
                console.error("Erreur lors de l'initialisation de Firebase:", error);
                // Afficher le message d'erreur et forcer l'interface d'auth
                authContainer.classList.remove('hidden');
                showAuthMessage(`Erreur d'initialisation critique: ${error.message}. V√©rifiez la console.`, 'error');
            }
        }

        // --- D√©marrage ---
        window.saveCounter = 0;
        
        window.onload = function() {
            loadTrack(currentTrackIndex); 
            initializeFirebase();
            setInterval(gameLoop, 100); 
        };

        // D√©tection du clic sur l'image pour autoriser la lecture audio 
        let hasInteracted = false;
        tiboImage.addEventListener('click', () => {
             if (!hasInteracted) {
                playMusic();
                hasInteracted = true;
            }
        });

    </script>
</body>
</html>
