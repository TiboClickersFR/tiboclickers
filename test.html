
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tibo Clicker - La Vraie Transfo' !</title>
    <!-- MISE √Ä JOUR : Le fichier "icon.png" est d√©fini comme ic√¥ne. -->
    <link rel="icon" type="image/png" href="icon.png"> 
    <style>
        /* CSS pour le style du jeu */
        body {
            /* Simule l'arri√®re-plan de Cookie Clicker (couleur sombre, motif subtil) */
            background-color: #0b0908; 
            color: #f7f7f7;
            font-family: 'Arial', sans-serif;
            text-align: center;
            margin: 0;
            padding: 20px;
            overflow-x: hidden;
            background-image: radial-gradient(circle, #222222 1px, transparent 1px);
            background-size: 15px 15px;
            /* Emp√™che la s√©lection de texte accidentelle sur mobile */
            user-select: none;
            -webkit-user-select: none;
        }

        #game-container {
            display: flex;
            max-width: 1000px;
            /* Limite la hauteur sur PC pour rendre l'interface plus compacte */
            max-height: 65vh; 
            height: 100%; 
            margin: 0 auto;
            border: 2px solid #5a5a5a;
            border-radius: 10px;
            background-color: #1a1a1a;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        #clicker-area {
            flex: 2;
            padding: 15px; 
            border-right: 2px solid #5a5a5a;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-around;
            position: relative; /* Pour le positionnement absolu des textes */
        }

        #upgrades-area {
            flex: 1;
            padding: 15px; 
            background-color: #2c2c2c;
            border-top-right-radius: 8px;
            border-bottom-right-radius: 8px;
            position: relative; 
            overflow-y: auto; 
            /* Limite la hauteur de la zone d'upgrades sur PC */
            max-height: 65vh; 
        }
        
        /* ------------------------------------------------ */
        /* Mise √† jour de la zone de clic/score */
        /* ------------------------------------------------ */

        #score-container {
            margin-bottom: 15px;
        }

        #score {
            font-size: 2.5em;
            font-weight: bold;
            color: #ffcc00; 
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px #000;
        }

        #tibo-image {
            width: 300px; 
            height: 300px; 
            border-radius: 50%; 
            cursor: pointer;
            box-shadow: 0 0 15px #ffcc00, 0 0 30px rgba(255, 204, 0, 0.5);
            transition: transform 0.05s; /* Transition tr√®s rapide pour le clic */
            object-fit: cover;
            /* Utilisation d'une image de Tibo (assum√©e √™tre 'Tibo.png' ou placeholder) */
            background-image: url('Tibo.png'); 
            background-size: cover;
            background-position: center;
            border: 5px solid #ffcc00;
            margin-bottom: 15px;
            
            /* OPTIMISATIONS MOBILE CRITIQUES */
            touch-action: manipulation; /* Emp√™che le zoom/scroll navigateur sur l'image */
            -webkit-tap-highlight-color: transparent; /* Enl√®ve le flash bleu au clic */
            user-select: none;
            -webkit-user-select: none;
            z-index: 5; /* S'assure que l'image est "au-dessus" du fond */
            position: relative;
        }

        #tibo-image:active {
            transform: scale(0.95); 
        }
        
        /* Classe active ajout√©e via JS pour le tactile */
        #tibo-image.active-touch {
            transform: scale(0.95);
        }
        
        #click-power-display, #tps-display {
            font-size: 1.2em;
            margin-top: 5px;
            color: #ccc;
        }
        
        /* NOUVEAU : Affichage des stats critiques */
        #crit-stats-display {
            font-size: 1em;
            margin-top: 10px;
            color: #e74c3c; /* Couleur rouge/critique */
            font-weight: bold;
        }

        /* Affichage de la nouvelle monnaie d'objectifs */
        #objective-currency-display {
            margin-top: 8px;
            font-size: 1.1em;
            color: #9fe6a0; /* Vert clair pour la monnaie d'objectifs */
            font-weight: bold;
        }

        /* Magasin d'objectifs */
        #objective-shop {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .objective-shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            border-radius: 6px;
        }
        .objective-shop-item button {
            background: #3b6f3b;
            color: #fff;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        /* ------------------------------------------------ */
        /* Mise √† jour des Am√©liorations */
        /* ------------------------------------------------ */

        .upgrade-button {
            width: 100%; 
            padding: 10px;
            margin: 6px 0;
            /* COULEUR DE FOND GRIS FONC√â UNIFORME */
            background-color: #3b3b3b;
            color: #f7f7f7;
            border: 2px solid #5a5a5a;
            border-radius: 8px; 
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s, transform 0.1s, opacity 0.5s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: left; 
            touch-action: manipulation; /* Am√©liore la r√©ponse tactile */
        }

        .upgrade-button:hover:not(:disabled) {
            background-color: #4f4f4f;
            transform: translateY(-2px);
        }

        .upgrade-button:disabled {
            background-color: #222222;
            color: #777;
            cursor: not-allowed;
            border-color: #333;
        }
        
        .upgrade-details {
            flex-grow: 1; 
        }
        
        .upgrade-title {
            font-weight: bold;
            color: #ffcc00;
            font-size: 1.1em;
        }
        
        /* Style sp√©cifique pour les upgrades critiques */
        .crit-upgrade .upgrade-title {
            color: #e74c3c; /* Rouge vif pour le critique */
        }

        /* Style sp√©cifique pour l'upgrade DIVIN */
        .god-upgrade {
            border: 2px solid #ffd700;
            background-color: #2a2002;
            box-shadow: 0 0 10px #ffd700;
        }
        .god-upgrade .upgrade-title {
            color: #ffff00;
            text-shadow: 0 0 5px #ffd700;
        }

        .upgrade-cost {
            font-weight: bold;
            color: #ffcc00;
            white-space: nowrap;
            margin-left: 10px; 
            flex-shrink: 0; 
        }
        
        .upgrade-count {
            display: block;
            font-size: 0.8em;
            color: #aaa;
            margin-top: 4px;
        }
        
        /* NOUVEAU: Classe pour cacher d√©finitivement l'am√©lioration */
        .hidden-maxed {
            display: none !important;
        }

        /* ------------------------------------------------ */
        /* Animations/Flottants */
        /* ------------------------------------------------ */

        .floating-text {
            position: absolute;
            font-size: 2em;
            color: #ffcc00;
            font-weight: bold;
            
            /* CRUCIAL POUR LE PROBL√àME MOBILE : */
            pointer-events: none !important; /* Force les clics √† passer au travers */
            
            opacity: 0;
            animation: floatUp 0.8s ease-out;
            text-shadow: 1px 1px 2px #000;
            z-index: 100; /* Au-dessus de tout visuellement, mais intouchable gr√¢ce √† pointer-events */
            white-space: nowrap;
        }
        
        /* NOUVEAU: Style sp√©cifique pour le boost critique */
        .floating-text.crit {
            color: #e74c3c; /* Rouge vif */
            font-size: 3em; 
            animation: floatUpCrit 1s ease-out; 
            z-index: 101;
        }

        @keyframes floatUp {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(-50px) scale(0.8);
                opacity: 0;
            }
        }
        
        @keyframes floatUpCrit {
            0% {
                transform: translateY(0) scale(1.2);
                opacity: 1;
            }
            50% {
                transform: translateY(-40px) scale(1.5); /* Monte un peu plus haut */
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) scale(1);
                opacity: 0;
            }
        }
        
        /* ------------------------------------------------ */
        /* Contr√¥les Haut de Page (Musique/Langue) */
        /* ------------------------------------------------ */

        #top-controls-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            flex-direction: column; 
            align-items: flex-end;
            margin-bottom: 15px;
        }
        
        #music-control {
            width: 100%;
            padding: 10px;
            background: #2c2c2c;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            font-size: 0.9em;
            margin-bottom: 10px; 
            box-sizing: border-box;
        }
        #music-control-buttons {
            display: flex;
            gap: 10px;
        }
        #music-control button {
            background: #4f4f4f;
            color: #ffcc00;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 3px;
            transition: background 0.2s;
        }
        
        #language-selector-container {
            width: 100%; 
            display: flex;
            justify-content: flex-end; 
            align-items: center;
            gap: 5px;
            font-size: 1.2em; 
            color: #ccc;
        }

        #language-selector {
            padding: 5px;
            border-radius: 5px;
            background-color: #3b3b3b;
            color: #f7f7f7;
            border: 1px solid #5a5a5a;
            cursor: pointer;
            font-size: 0.9em;
            appearance: none; 
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24'%3E%3Cpath fill='white' d='M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 5px center;
            padding-right: 25px; 
        }

        /* NOUVEAU: Style pour la zone de sauvegarde */
        #save-load-container {
            max-width: 1000px;
            margin: 15px auto 0;
            padding: 15px 20px;
            background-color: #1a1a1a;
            border: 2px solid #5a5a5a;
            border-radius: 10px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap; /* Permet le retour √† la ligne sur mobile */
            justify-content: space-between;
        }
        
        #save-load-container button {
            flex-grow: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
            min-width: 150px;
        }
        
        #save-btn {
            background-color: #2a6f2a; /* Vert */
        }
        #save-btn:hover {
            background-color: #3b8e3b;
        }
        
        #load-btn {
            background-color: #8b4513; /* Marron/Orange */
        }
        #load-btn:hover {
            background-color: #a0522d;
        }
        
        /* NOUVEAU: Style pour les messages de statut */
        #status-message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            display: none; /* Cach√© par d√©faut */
        }
        
        .status-success {
            background-color: #4CAF50; /* Vert succ√®s */
            color: white;
        }

        .status-error {
            background-color: #f44336; /* Rouge erreur */
            color: white;
        }


        /* ------------------------------------------------ */
        /* R√®gles de Responsivit√© (Media Queries) */
        /* ------------------------------------------------ */

        @media (max-width: 768px) {
            
            body {
                padding: 10px;
            }

            #game-container {
                flex-direction: column; /* La zone de clic passe au-dessus des upgrades */
                width: 100%;
                max-height: none; /* Supprime la limite de hauteur sur mobile */
                height: auto;
            }

            #clicker-area {
                border-right: none; 
                border-bottom: 2px solid #5a5a5a; 
                padding: 15px;
            }

            #upgrades-area {
                border-top-right-radius: 0;
                border-bottom-left-radius: 8px;
                max-height: 50vh; /* Limite la hauteur de la liste pour laisser de la place au clic */
                overflow-y: scroll;
            }

            #tibo-image {
                width: 250px; 
                height: 250px;
                margin: 15px auto; 
            }
            
            #score {
                font-size: 2em; 
            }

            #click-power-display, #tps-display {
                font-size: 1em; 
            }
            
            #top-controls-container {
                padding: 0 10px; 
            }
            
            #music-control {
                flex-direction: column; 
                align-items: flex-start;
            }
            #music-control-buttons {
                width: 100%;
                justify-content: space-around; 
            }
            
            #language-selector-container {
                justify-content: flex-end; 
            }
            
            #save-load-container {
                padding: 10px;
                flex-direction: column; /* Les boutons sont empil√©s sur mobile */
            }
        }
    </style>
</head>
<body>

    <h1 id="main-title">Tibo Clicker - La Vraie Transfo' ! üí™</h1>
    
    <!-- CONTENEUR GLOBAL POUR LES CONTR√îLES -->
    <div id="top-controls-container">
        <!-- 1. Contr√¥le Musique (Large) -->
        <div id="music-control">
            <!-- TITRE DE LA PISTE MIS √Ä JOUR POUR CORRESPONDRE √Ä LA NOUVELLE PLAYLIST -->
            <p><span id="music-label">Musique</span> : <span id="current-track-title">Damn (Gabin)</span></p>
            <div id="music-control-buttons">
                 <button onclick="toggleMusic()">‚ñ∂Ô∏è</button>
                 <button onclick="nextTrack()">‚è≠Ô∏è</button>
            </div>
        </div>

        <!-- 2. S√©lecteur de Langue -->
        <div id="language-selector-container">
            <span id="lang-label">üåê</span>
            <select id="language-selector" onchange="setLanguage(this.value, false)">
                <option value="fr">Fran√ßais</option>
                <option value="en">English</option>
                <option value="es">Espa√±ol</option>
            </select>
        </div>
    </div>


    <!-- üéß √âl√©ment Audio unique pour la lecture de la playlist -->
    <audio id="background-music" preload="auto"></audio>

    <div id="game-container">
        
        <div id="clicker-area">
            
            <div id="score-container">
                <p id="tibos-owned-label">Tibos Poss√©d√©s :</p>
                <div id="score">0</div>
                <div id="click-power-display">Puissance de Clic : 1 Tibo</div>
                <div id="tps-display">Tibos par Seconde (TPS) : 0</div>
                <!-- NOUVEAU: Affichage des statistiques de boost critique -->
                <div id="crit-stats-display">Transfo' Critique : 0.0% (x2)</div>
                    <!-- NOUVEAU: Affichage de la monnaie d'objectifs -->
                    <div id="objective-currency-display">Points d'Objectif : 0</div>
            </div>

            <!-- Image de Tibo : Notez l'absence d'√©v√©nement onclick inline, tout est g√©r√© en JS -->
            <div id="tibo-image"></div>

        </div>

        <div id="upgrades-area">
            <h2 id="upgrades-title">Am√©liorations</h2>

            <!-- NOUVEAU: Panneau d'Objectifs -->
            <div id="objectives-panel" style="text-align:left; margin-top:12px;">
                <h3 style="color:#9fe6a0; margin:0 0 8px 0;">Objectifs</h3>
                <div id="objectives-list">
                    <!-- Les objectifs seront inject√©s ici par JS -->
                </div>
                <div id="objective-shop">
                    <!-- Items injected by JS -->
                </div>
            </div>

            <!-- Am√©liorations de Clic (Bonus Additif Unique) -->
            <div id="click-multiplier-container" class="new-upgrade-container">
                <!-- Upgrade 1 initiale -->
                <!-- Ces achats sont uniques, ils utilisent data-cost -->
                <button id="upgrade-click-1" class="upgrade-button" data-cost="100" data-add-bonus="1" data-purchased="false" data-upgrade-key="mindset" data-max-once="true">
                    <div class="upgrade-details">
                        <span class="upgrade-title">Mise en Place du "Mindset"</span>
                        <br><span class="upgrade-description">Ajoute +1 TPC de base (Achat Unique)</span>
                    </div>
                    <span class="upgrade-cost">100 Tibos</span> 
                </button>
                
                <!-- Upgrade 2 -->
                 <button id="upgrade-click-2-new" class="upgrade-button hidden" data-cost="500" data-add-bonus="3" data-purchased="false" data-upgrade-key="ultrasale" data-max-once="true">
                    <div class="upgrade-details">
                        <span class="upgrade-title">Tibo Ultra Sale üí•</span>
                        <br><span class="upgrade-description">Ajoute +3 TPC de base (Achat Unique)</span>
                    </div>
                    <span class="upgrade-cost">500 Tibos</span>
                </button>
                
                <!-- Upgrade 3 -->
                 <button id="upgrade-click-3-new" class="upgrade-button hidden" data-cost="3000" data-add-bonus="6" data-purchased="false" data-upgrade-key="cheatmeal" data-max-once="true">
                    <div class="upgrade-details">
                        <span class="upgrade-title">Le Cheat Meal Ultime üçï</span>
                        <br><span class="upgrade-description">Ajoute +6 TPC de base (Achat Unique)</span>
                    </div>
                    <span class="upgrade-cost">3000 Tibos</span>
                </button>

                <!-- NOUVELLE UPGRADE ULTIME : MULTIPLICATEUR X5000 -->
                 <button id="upgrade-click-god" class="upgrade-button god-upgrade hidden" data-cost="1000000000000" data-multiplier="5000" data-purchased="false" data-upgrade-key="godmode" data-max-once="true">
                    <div class="upgrade-details">
                        <span class="upgrade-title">La Transfo Divine ‚ö°</span>
                        <br><span class="upgrade-description">Multiplie le clic par 5000 (Achat Unique)</span>
                    </div>
                    <span class="upgrade-cost">1T Tibos</span>
                </button>

            </div>
            
            <hr style="border-color: #5a5a5a; margin: 15px 0;">

            <!-- NOUVELLES AM√âLIORATIONS CRITIQUES -->
             <button id="upgrade-crit-chance" class="upgrade-button crit-upgrade" data-base-cost="20000" data-growth="1.3" data-crit-chance-add="0.5" data-count="0" data-upgrade-key="critChance">
                <div class="upgrade-details">
                    <span class="upgrade-title">Chance de Transfo' Critique üìà</span>
                    <br><span class="upgrade-description">Augmente la chance de boost de 0.5%</span>
                    <span class="upgrade-count">Poss√©d√©: 0</span>
                </div>
                <span class="upgrade-cost">20000 Tibos</span>
            </button>
            
            <button id="upgrade-crit-power" class="upgrade-button crit-upgrade" data-base-cost="50000" data-growth="1.3" data-crit-power-add="2" data-count="0" data-upgrade-key="critPower">
                <div class="upgrade-details">
                    <span class="upgrade-title">Puissance de Transfo' Critique üî•</span>
                    <br><span class="upgrade-description">Augmente le multiplicateur de boost de x2 (base x2)</span>
                    <span class="upgrade-count">Poss√©d√©: 0</span>
                </div>
                <span class="upgrade-cost">50000 Tibos</span>
            </button>
            
            <hr style="border-color: #5a5a5a; margin: 15px 0;">

            <!-- Am√©lioration du Clic (Ajout) - Prix exponentiel -->
            <!-- Ces achats sont r√©p√©tables, ils utilisent data-base-cost -->
            <button id="upgrade-addition" class="upgrade-button" data-base-cost="2000" data-growth="1.15" data-addition="5" data-count="0" data-upgrade-key="proteines">
                <div class="upgrade-details">
                    <span class="upgrade-title">D√©verrouillage des Prot√©ines</span>
                    <br><span class="upgrade-description">Ajoute +5 Tibos par Clic</span>
                    <span class="upgrade-count">Poss√©d√©: 0</span>
                </div>
                <span class="upgrade-cost">2000 Tibos</span>
            </button>

            <!-- NOUVELLE AM√âLIORATION : Pack Massif (1 Milliard) -->
            <button id="upgrade-addition-1b" class="upgrade-button" data-base-cost="1000000000" data-growth="1.15" data-addition="30" data-count="0" data-upgrade-key="megaProtein">
                <div class="upgrade-details">
                    <span class="upgrade-title">Pack d'entra√Ænement Massif</span>
                    <br><span class="upgrade-description">Ajoute +30 TPC de base par achat</span>
                    <span class="upgrade-count">Poss√©d√©: 0</span>
                </div>
                <span class="upgrade-cost">1,000,000,000 Tibos</span>
            </button>

            <!-- Am√©lioration Passive 1 - Alessio -->
            <button id="upgrade-passive-alessiode" class="upgrade-button" data-base-cost="500" data-growth="1.15" data-tps="1" data-count="0" data-upgrade-key="alessio">
                <div class="upgrade-details">
                    <span class="upgrade-title">Alessiode - Coach Personnel üèãÔ∏è</span>
                    <br><span class="upgrade-description">G√©n√®re 1 Tibo/s</span>
                    <span class="upgrade-count">Poss√©d√©: 0</span>
                </div>
                <span class="upgrade-cost">500 Tibos</span>
            </button>
            
            <!-- Am√©lioration Passive 2 - Justine -->
            <button id="upgrade-passive-justine" class="upgrade-button" data-base-cost="5000" data-growth="1.15" data-tps="10" data-count="0" data-upgrade-key="justine">
                <div class="upgrade-details">
                    <span class="upgrade-title">Justine - Community Manager üì∏</span>
                    <br><span class="upgrade-description">G√©n√®re 10 Tibos/s</span>
                    <span class="upgrade-count">Poss√©d√©: 0</span>
                </div>
                <span class="upgrade-cost">5000 Tibos</span>
            </button>
            
            <!-- Am√©lioration Passive 3 - Patate Douce (CHEATEE: 150 TPS) -->
            <button id="upgrade-passive-patate" class="upgrade-button" data-base-cost="40000" data-growth="1.15" data-tps="150" data-count="0" data-upgrade-key="patates">
                <div class="upgrade-details">
                    <span class="upgrade-title">L'Usine √† Patates Douces COSMIQUE üç†üöÄ</span>
                    <br><span class="upgrade-description">G√©n√®re 150 Tibos/s</span>
                    <span class="upgrade-count">Poss√©d√©: 0</span>
                </div>
                <span class="upgrade-cost">40000 Tibos</span>
            </button>

            <!-- NOUVELLE AM√âLIORATION : Nogode -->
            <button id="upgrade-passive-nogode" class="upgrade-button" data-base-cost="200000" data-growth="1.15" data-tps="500" data-count="0" data-upgrade-key="nogode">
                <div class="upgrade-details">
                    <span class="upgrade-title">Nogode - Le Disrupteur Sombre üñ§</span>
                    <br><span class="upgrade-description">G√©n√®re 500 Tibos/s</span>
                    <span class="upgrade-count">Poss√©d√©: 0</span>
                </div>
                <span class="upgrade-cost">200000 Tibos</span>
            </button>

            <!-- NOUVELLE AM√âLIORATION : Sachatte -->
            <button id="upgrade-passive-sachatte" class="upgrade-button" data-base-cost="1000000" data-growth="1.15" data-tps="2000" data-count="0" data-upgrade-key="sachatte">
                <div class="upgrade-details">
                    <span class="upgrade-title">Sachatte - L'√âclaireuse Mystique ‚ú®</span>
                    <br><span class="upgrade-description">G√©n√®re 2,000 Tibos/s</span>
                    <span class="upgrade-count">Poss√©d√©: 0</span>
                </div>
                <span class="upgrade-cost">1000000 Tibos</span>
            </button>
            
            <!-- AM√âLIORATION CORRIG√âE : Milodes (Le style est g√©r√© par la classe .upgrade-button) -->
            <button id="upgrade-passive-milodes" class="upgrade-button" data-base-cost="8000000" data-growth="1.15" data-tps="10000" data-count="0" data-upgrade-key="milodes">
                <div class="upgrade-details">
                    <span class="upgrade-title">Milodes - Le Mobilisateur Instantan√© üöÄ</span>
                    <br><span class="upgrade-description">G√©n√®re 10,000 Tibos/s</span>
                    <span class="upgrade-count">Poss√©d√©: 0</span>
                </div>
                <span class="upgrade-cost">8000000 Tibos</span>
            </button>

            <!-- NOUVELLE AM√âLIORATION : Thomas -->
            <button id="upgrade-passive-thomas" class="upgrade-button" data-base-cost="50000000" data-growth="1.15" data-tps="50000" data-count="0" data-upgrade-key="thomas">
                <div class="upgrade-details">
                    <span class="upgrade-title">Thomas - L'Architecte des Ressources üí∞</span>
                    <br><span class="upgrade-description">G√©n√®re 50,000 Tibos/s</span>
                    <span class="upgrade-count">Poss√©d√©: 0</span>
                </div>
                <span class="upgrade-cost">50000000 Tibos</span>
            </button>

            <!-- NOUVELLE AM√âLIORATION : Lenaik -->
            <button id="upgrade-passive-lenaik" class="upgrade-button" data-base-cost="200000000" data-growth="1.15" data-tps="200000" data-count="0" data-upgrade-key="lenaik">
                <div class="upgrade-details">
                    <span class="upgrade-title">Lenaik - La Gardienne Hyper-Protectrice üõ°Ô∏è</span>
                    <br><span class="upgrade-description">G√©n√®re 200,000 Tibos/s</span>
                    <span class="upgrade-count">Poss√©d√©: 0</span>
                </div>
                <span class="upgrade-cost">200000000 Tibos</span>
            </button>
            
            <!-- NOUVELLE AM√âLIORATION : Rodrigues -->
            <button id="upgrade-passive-rodrigues" class="upgrade-button" data-base-cost="1000000000" data-growth="1.15" data-tps="1000000" data-count="0" data-upgrade-key="rodrigues">
                <div class="upgrade-details">
                    <span class="upgrade-title">Rodrigues - Le B√¢ton de P√®lerin üí´</span>
                    <br><span class="upgrade-description">G√©n√®re 1,000,000 Tibos/s</span>
                    <span class="upgrade-count">Poss√©d√©: 0</span>
                </div>
                <span class="upgrade-cost">1000000000 Tibos</span>
            </button>
            
            <!-- NOUVELLE AM√âLIORATION : Minotaure üêÇ -->
            <button id="upgrade-passive-minotaure" class="upgrade-button" data-base-cost="5000000000" data-growth="1.15" data-tps="5000000" data-count="0" data-upgrade-key="minotaure">
                <div class="upgrade-details">
                    <span class="upgrade-title">Minotaure - Tu veux qu'il te fasse quoi ? üêÇ</span>
                    <br><span class="upgrade-description">Le Taureau de Cr√®te. G√©n√®re 5,000,000 Tibos/s</span>
                    <span class="upgrade-count">Poss√©d√©: 0</span>
                </div>
                <span class="upgrade-cost">5000000000 Tibos</span>
            </button>
            
            <!-- AM√âLIORATION : BoomFred (LE PLUS PUISSANT) -->
            <button id="upgrade-passive-boomfred" class="upgrade-button" data-base-cost="25000000000" data-growth="1.15" data-tps="25000000" data-count="0" data-upgrade-key="boomfred">
                <div class="upgrade-details">
                    <span class="upgrade-title">BoomFred - Le goat du sax et de Glazunov üé∑</span>
                    <br><span class="upgrade-description">G√©n√®re 25,000,000 Tibos/s</span>
                    <span class="upgrade-count">Poss√©d√©: 0</span>
                </div>
                <span class="upgrade-cost">25000000000 Tibos</span>
            </button>

            <!-- NOUVELLE AM√âLIORATION : Tomasi -->
            <button id="upgrade-passive-tomasi" class="upgrade-button" data-base-cost="200000000000" data-growth="1.15" data-tps="150000000" data-count="0" data-upgrade-key="tomasi">
                <div class="upgrade-details">
                    <span class="upgrade-title">Tomasi - La M√©lodie Divine üéµ</span>
                    <br><span class="upgrade-description">G√©n√®re 150,000,000 Tibos/s</span>
                    <span class="upgrade-count">Poss√©d√©: 0</span>
                </div>
                <span class="upgrade-cost">200,000,000,000 Tibos</span>
            </button>

            <!-- NOUVELLE AM√âLIORATION : SperGabMaker -->
            <button id="upgrade-passive-spergabmaker" class="upgrade-button" data-base-cost="2000000000000" data-growth="1.15" data-tps="1000000000" data-count="0" data-upgrade-key="spergabmaker">
                <div class="upgrade-details">
                    <span class="upgrade-title">SperGabMaker - L'Alchimiste Supr√™me üß¨</span>
                    <br><span class="upgrade-description">G√©n√®re 1,000,000,000 Tibos/s</span>
                    <span class="upgrade-count">Poss√©d√©: 0</span>
                </div>
                <span class="upgrade-cost">2,000,000,000,000 Tibos</span>
            </button>

            <!-- NOUVELLE AM√âLIORATION : Tim√©to -->
            <button id="upgrade-passive-timeto" class="upgrade-button" data-base-cost="25000000000000" data-growth="1.15" data-tps="10000000000" data-count="0" data-upgrade-key="timeto">
                <div class="upgrade-details">
                    <span class="upgrade-title">Tim√©to - Le Ma√Ætre du Temps ‚è≥</span>
                    <br><span class="upgrade-description">G√©n√®re 10,000,000,000 Tibos/s</span>
                    <span class="upgrade-count">Poss√©d√©: 0</span>
                </div>
                <span class="upgrade-cost">25,000,000,000,000 Tibos</span>
            </button>

            <!-- NOUVELLE AM√âLIORATION : Boubou -->
            <button id="upgrade-passive-boubou" class="upgrade-button" data-base-cost="500000000000000" data-growth="1.15" data-tps="200000000000" data-count="0" data-upgrade-key="boubou">
                <div class="upgrade-details">
                    <span class="upgrade-title">Boubou - Bienvenue chez nous fr√®re ü§ù</span>
                    <br><span class="upgrade-description">G√©n√®re 200,000,000,000 Tibos/s</span>
                    <span class="upgrade-count">Poss√©d√©: 0</span>
                </div>
                <span class="upgrade-cost">500,000,000,000,000 Tibos</span>
            </button>
            
        </div>
        
    </div>

    <!-- NOUVEAU CONTENEUR DE SAUVEGARDE ET RESTAURATION -->
    <div id="save-load-container">
        <button id="save-btn">T√©l√©charger la Sauvegarde (.tibo)</button>
        <button id="load-btn">Charger une Sauvegarde (.tibo)</button>
        <!-- Champ de fichier cach√© pour l'import -->
        <input type="file" id="file-input" accept=".tibo" style="display: none;">
        <!-- Message de statut -->
        <div id="status-message" style="display: none;"></div>
    </div>


    <script>
        // JavaScript pour la logique du jeu
        let score = 0;
        let clickPower = 1; // Puissance de clic totale (base + bonus)
        let tps = 0; // Tibos Par Seconde
        
        // NOUVEAU: Monnaie d'Objectifs
        let objectiveCurrency = 0; // Nouvelle monnaie r√©compens√©e par les objectifs
        // Statistiques pour le suivi des objectifs
        let totalClicks = 0;
        let totalPurchases = 0;
        let totalCrits = 0; // nombre total de clicks critiques
        let clickTimestamps = []; // timestamps des clics r√©cents (pour objectifs temporels)
        
        // NOUVEAU: Statistiques Critiques
        let baseCritChance = 0; // MODIFICATION: 0% de base
        let critChancePerUpgrade = 0.5; // MODIFICATION: 0.5% ajout√© par achat
        
        let totalCritChance = baseCritChance; // Chance actuelle en pourcentage (e.g., 0.5, 1.0, ...)
        
        let totalCritPower = 2; // Multiplicateur de base (x2)
        let critPowerPerUpgrade = 2; // x2 ajout√© par achat (x2, x4, x6, ...)
        
        // Ancienne constante GROWTH_FACTOR (1.15) est maintenant utilis√©e dans data-growth pour les upgrades passifs
        const CRIT_GROWTH_FACTOR = 1.3; // Facteur d'augmentation pour les upgrades critiques (plus rapide)
        const MAX_CRIT_CHANCE = 100; // La chance critique maximale est 100%

        let currentLang = 'fr'; // Langue par d√©faut
        const GAME_STORAGE_KEY = 'tiboClickerSave';
        const LANG_STORAGE_KEY = 'tiboClickerLang';
        
        const scoreDisplay = document.getElementById('score');
        const objectiveCurrencyDisplay = document.getElementById('objective-currency-display');
        const tiboImage = document.getElementById('tibo-image');
        const clickPowerDisplay = document.getElementById('click-power-display');
        const tpsDisplay = document.getElementById('tps-display');
        const critStatsDisplay = document.getElementById('crit-stats-display'); // NOUVEAU
        
        // R√©f√©rences aux boutons pour la gestion de l'apparition
        const upgrade1 = document.getElementById('upgrade-click-1');
        const upgrade2_new = document.getElementById('upgrade-click-2-new'); 
        const upgrade3_new = document.getElementById('upgrade-click-3-new'); 
        const upgradeGod = document.getElementById('upgrade-click-god'); // NOUVEAU
        
        // R√©f√©rences aux upgrades critiques
        const critChanceUpgradeBtn = document.getElementById('upgrade-crit-chance');
        const critPowerUpgradeBtn = document.getElementById('upgrade-crit-power');
        
        // Liste de tous les boutons (incluant les cach√©s pour la v√©rification des co√ªts)
        const upgradeButtons = [
            upgrade1,
            upgrade2_new,
            upgrade3_new,
            upgradeGod, // AJOUT
            document.getElementById('upgrade-addition-1b'),
            critChanceUpgradeBtn,
            critPowerUpgradeBtn,
            document.getElementById('upgrade-addition'),
            document.getElementById('upgrade-addition-1b'),
            document.getElementById('upgrade-passive-alessiode'),
            document.getElementById('upgrade-passive-justine'),
            document.getElementById('upgrade-passive-patate'),
            // Nouveaux Personnages
            document.getElementById('upgrade-passive-nogode'), 
            document.getElementById('upgrade-passive-sachatte'),
            document.getElementById('upgrade-passive-milodes'),
            document.getElementById('upgrade-passive-thomas'),
            document.getElementById('upgrade-passive-lenaik'),
            document.getElementById('upgrade-passive-rodrigues'),
            document.getElementById('upgrade-passive-minotaure'),
            // NOUVEAU : BoomFred
            document.getElementById('upgrade-passive-boomfred'),
            // AJOUTS R√âCENTS
            document.getElementById('upgrade-passive-tomasi'),
            document.getElementById('upgrade-passive-boubou'),
            document.getElementById('upgrade-passive-spergabmaker'),
            document.getElementById('upgrade-passive-timeto')
        ];
        
        // --- Dictionnaire de Traduction (Translations Dictionary) ---
        const translations = {
            fr: {
                // G√©n√©ral
                langLabel: "üåê", 
                mainTitle: "Tibo Clicker - La Vraie Transfo' ! üí™",
                musicLabel: "Musique", 
                tibosOwnedLabel: "Tibos Poss√©d√©s :",
                clickPowerDisplay: (power) => `Puissance de Clic : ${formatScore(power)} Tibo${power > 1 ? 's' : ''}`,
                tpsDisplay: (tps) => `Tibos par Seconde (TPS) : ${tps > 1000 ? tps.toFixed(1) : tps.toFixed(0)}`,
                // NOUVEAU: Affichage Critiques
                // MODIFICATION : Utilise critChancePerUpgrade pour la description traduite
                critStatsDisplay: (chance, power) => `Transfo' Critique : ${chance.toFixed(1)}% (x${power.toFixed(0)})`,
                upgradesTitle: "Am√©liorations",
                // Upgrades Multiplicateurs (Achat Unique)
                mindsetTitle: "Mise en Place du \"Mindset\"",
                mindsetDescription: "Ajoute +1 TPC de base (Achat Unique)",
                ultrasaleTitle: "Tibo Ultra Sale üí•",
                ultrasaleDescription: "Ajoute +3 TPC de base (Achat Unique)",
                cheatmealTitle: "Le Cheat Meal Ultime üçï",
                cheatmealDescription: "Ajoute +6 TPC de base (Achat Unique)",
                // NOUVEAU
                godmodeTitle: "La Transfo Divine ‚ö°",
                godmodeDescription: "Multiplie tous les clics par 5000 (Achat Unique)",
                
                // MODIFICATION: Description avec 0.5%
                critChanceTitle: "Chance de Transfo' Critique üìà",
                critChanceDescription: `Augmente la chance de boost de ${critChancePerUpgrade.toFixed(1)}%`,
                critPowerTitle: "Puissance de Transfo' Critique üî•",
                critPowerDescription: "Augmente le multiplicateur de boost de x2 (base x2)",
                // Upgrades R√©p√©tables
                proteinesTitle: "D√©verrouillage des Prot√©ines",
                proteinesDescription: "Ajoute +5 Tibos par Clic",
                megaProteinTitle: "Pack d'entra√Ænement Massif",
                megaProteinDescription: "Ajoute +30 TPC de base par achat",
                objectiveCurrencyName: "Points d'Objectif",
                objectivesTitle: "Objectifs",
                objective_clicks_100_title: "Clicker Novice",
                objective_clicks_100_desc: "Clique 100 fois",
                objective_score_1000_title: "Tibos D√©butant",
                objective_score_1000_desc: "Atteindre 1,000 Tibos",
                objective_first_buy_title: "Premier Achat",
                objective_first_buy_desc: "Acheter votre premi√®re am√©lioration",
                objective_reward_received: "R√©compense re√ßue : +",
                shop_perm_click_x2_title: "Double Clic Permanent",
                shop_perm_click_x2_desc: "Double vos Tibos par clic pour toujours (stackable)",
                shop_temp_click_x2h_title: "Double Clic (1h)",
                shop_temp_click_x2h_desc: "Double vos Tibos par clic pendant 1 heure",
                shop_price_reduce_title: "R√©duction des Prix",
                shop_price_reduce_desc: "R√©duit le prix des am√©liorations de 5% (empilable)",
                notEnoughObjectivePoints: "Pas assez de Points d'Objectif",
                timed_clicks_title: "Marathon de Clics",
                timed_clicks_desc: (target, dur) => `Faire ${target} clics en ${dur} secondes`,
                buy_upgrade_title: "Acheter Sp√©cifique",
                buy_upgrade_desc: (target, upg) => `Acheter ${target}x l'am√©lioration ${upg}`,
                tps_title: "Atteindre TPS",
                tps_desc: (target) => `Atteindre ${formatScore(target)} Tibos/s`,
                crits_title: "Crit Master",
                crits_desc: (target) => `Obtenir ${target} Transfo' Critiques`,
                alessioTitle: "Alessiode - Coach Personnel üèãÔ∏è",
                alessioDescription: "G√©n√®re 1 Tibo/s",
                justineTitle: "Justine - Community Manager üì∏",
                justineDescription: "G√©n√®re 10 Tibos/s",
                patatesTitle: "L'Usine √† Patates Douces COSMIQUE üç†üöÄ",
                patatesDescription: "G√©n√®re 150 Tibos/s",
                nogodeTitle: "Nogode - Le Disrupteur Sombre üñ§",
                nogodeDescription: "G√©n√®re 500 Tibos/s",
                sachatteTitle: "Sachatte - L'√âclaireuse Mystique ‚ú®",
                sachatteDescription: "G√©n√®re 2,000 Tibos/s",
                milodesTitle: "Milodes - Le Mobilisateur Instantan√© üöÄ",
                milodesDescription: "G√©n√®re 10,000 Tibos/s",
                thomasTitle: "Thomas - L'Architecte des Ressources üí∞",
                thomasDescription: "G√©n√®re 50,000 Tibos/s",
                lenaikTitle: "Lenaik - La Gardienne Hyper-Protectrice üõ°Ô∏è",
                lenaikDescription: "G√©n√®re 200,000 Tibos/s",
                rodriguesTitle: "Rodrigues - Le B√¢ton de P√®lerin üí´",
                rodriguesDescription: "G√©n√®re 1,000,000 Tibos/s",
                minotaureTitle: "Minotaure - Tu veux qu'il te fasse quoi ? üêÇ",
                minotaureDescription: "Le Taureau de Cr√®te. G√©n√®re 5,000,000 Tibos/s",
                boomfredTitle: "BoomFred - Le goat du sax et de Glazunov üé∑",
                boomfredDescription: "G√©n√®re 25,000,000 Tibos/s",
                // NOUVEAUX
                tomasiTitle: "Tomasi - La M√©lodie Divine üéµ",
                tomasiDescription: "G√©n√®re 150,000,000 Tibos/s",
                boubouTitle: "Boubou - Bienvenue chez nous fr√®re ü§ù",
                boubouDescription: "G√©n√®re 200,000,000,000 Tibos/s",
                spergabmakerTitle: "SperGabMaker - L'Alchimiste Supr√™me üß¨",
                spergabmakerDescription: "G√©n√®re 1,000,000,000 Tibos/s",
                timetoTitle: "Tim√©to - Le Ma√Ætre du Temps ‚è≥",
                timetoDescription: "G√©n√®re 10,000,000,000 Tibos/s",
                // Texte secondaire
                countText: (count) => `Poss√©d√©: ${count}`,
                costText: (cost) => `${formatScore(cost)} Tibos`,
                purchasedText: "Achet√©", 
                // NOUVEAU: Textes de Sauvegarde/Restauration
                saveButton: "T√©l√©charger la Sauvegarde (.tibo)",
                loadButton: "Charger une Sauvegarde (.tibo)",
                saveSuccess: "Sauvegarde t√©l√©charg√©e avec succ√®s !",
                loadSuccess: "Jeu restaur√© avec succ√®s depuis le fichier !",
                loadCorrupted: "Erreur : Le fichier de sauvegarde est corrompu ou invalide.",
                loadFileError: "Erreur lors de la lecture du fichier.",
                fileTypeWrong: "Erreur : Veuillez s√©lectionner un fichier de sauvegarde Tibo Clicker (.tibo).",
                maxCritChanceReached: "Chance Max atteinte (100%)" 
            },
            en: {
                // General
                langLabel: "üåê", 
                mainTitle: "Tibo Clicker - The Real Transformation! üí™",
                musicLabel: "Music", 
                tibosOwnedLabel: "Tibos Owned:",
                clickPowerDisplay: (power) => `Click Power: ${formatScore(power)} Tibo${power > 1 ? 's' : ''}`,
                tpsDisplay: (tps) => `Tibos Per Second (TPS): ${tps > 1000 ? tps.toFixed(1) : tps.toFixed(0)}`,
                // NOUVEAU: Affichage Critiques
                // MODIFICATION : Utilise critChancePerUpgrade pour la description traduite
                critStatsDisplay: (chance, power) => `Critical Transfo' : ${chance.toFixed(1)}% (x${power.toFixed(0)})`,
                upgradesTitle: "Upgrades",
                // Multiplier Upgrades (One-Time Purchase)
                mindsetTitle: "\"Mindset\" Implementation",
                mindsetDescription: "Adds +1 base TPC (One-Time Purchase)",
                ultrasaleTitle: "Tibo Ultra Sale üí•",
                ultrasaleDescription: "Adds +3 base TPC (One-Time Purchase)",
                cheatmealTitle: "The Ultimate Cheat Meal üçï",
                cheatmealDescription: "Adds +6 base TPC (One-Time Purchase)",
                // NOUVEAU
                godmodeTitle: "The Divine Transfo ‚ö°",
                godmodeDescription: "Multiplies all clicks by 5000 (One-Time Purchase)",

                // MODIFICATION: Description avec 0.5%
                critChanceTitle: "Critical Transfo' Chance üìà",
                critChanceDescription: `Increases boost chance by ${critChancePerUpgrade.toFixed(1)}%`,
                critPowerTitle: "Critical Transfo' Power üî•",
                critPowerDescription: "Increases boost multiplier by x2 (base x2)",
                // Repeatable Upgrades
                proteinesTitle: "Protein Unlock",
                proteinesDescription: "Adds +5 Tibos per Click",
                megaProteinTitle: "Massive Training Pack",
                megaProteinDescription: "Adds +30 base TPC per purchase",
                objectiveCurrencyName: "Objective Points",
                objectivesTitle: "Objectives",
                objective_clicks_100_title: "Clicker Novice",
                objective_clicks_100_desc: "Click 100 times",
                objective_score_1000_title: "Tibos Starter",
                objective_score_1000_desc: "Reach 1,000 Tibos",
                objective_first_buy_title: "First Purchase",
                objective_first_buy_desc: "Buy your first upgrade",
                objective_reward_received: "Reward received: +",
                shop_perm_click_x2_title: "Permanent Click x2",
                shop_perm_click_x2_desc: "Double your Tibos per click forever (stackable)",
                shop_temp_click_x2h_title: "Click x2 (1h)",
                shop_temp_click_x2h_desc: "Double your Tibos per click for 1 hour",
                shop_price_reduce_title: "Price Reduction",
                shop_price_reduce_desc: "Reduces upgrade prices by 5% (stackable)",
                notEnoughObjectivePoints: "Not enough Objective Points",
                timed_clicks_title: "Click Marathon",
                timed_clicks_desc: (target, dur) => `Do ${target} clicks in ${dur} seconds`,
                buy_upgrade_title: "Buy Specific Upgrade",
                buy_upgrade_desc: (target, upg) => `Buy ${target}x the upgrade ${upg}`,
                tps_title: "Reach TPS",
                tps_desc: (target) => `Reach ${formatScore(target)} Tibos/s`,
                crits_title: "Crit Master",
                crits_desc: (target) => `Get ${target} Critical Transfos`,
                alessioTitle: "Alessiode - Personal Coach üèãÔ∏è",
                alessioDescription: "Generates 1 Tibo/s",
                justineTitle: "Justine - Community Manager üì∏",
                justineDescription: "Generates 10 Tibo/s",
                patatesTitle: "The COSMIC Sweet Potato Factory üç†üöÄ",
                patatesDescription: "Generates 150 Tibo/s",
                nogodeTitle: "Nogode - The Dark Disruptor üñ§",
                nogodeDescription: "Generates 500 Tibo/s",
                sachatteTitle: "Sachatte - The Mystic Scout ‚ú®",
                sachatteDescription: "Generates 2,000 Tibo/s",
                milodesTitle: "Milodes - The Instant Mobilizer üöÄ",
                milodesDescription: "Generates 10,000 Tibo/s",
                thomasTitle: "Thomas - The Resource Architect üí∞",
                thomasDescription: "Generates 50,000 Tibo/s",
                lenaikTitle: "Lenaik - The Hyper-Protective Guardian üõ°Ô∏è",
                lenaikDescription: "Generates 200,000 Tibo/s",
                rodriguesTitle: "Rodrigues - The Pilgrim's Staff üí´",
                rodriguesDescription: "Generates 1,000,000 Tibo/s",
                minotaureTitle: "Minotaur - What do you want him to do? üêÇ",
                minotaureDescription: "The Cretan Bull. Generates 5,000,000 Tibo/s",
                boomfredTitle: "BoomFred - The Sax and Glazunov GOAT üé∑",
                boomfredDescription: "Generates 25,000,000 Tibo/s",
                // NEW
                tomasiTitle: "Tomasi - The Divine Melody üéµ",
                tomasiDescription: "Generates 150,000,000 Tibo/s",
                boubouTitle: "Boubou - Welcome home brother ü§ù",
                boubouDescription: "Generates 200,000,000,000 Tibo/s",
                spergabmakerTitle: "SperGabMaker - The Supreme Alchemist üß¨",
                spergabmakerDescription: "Generates 1,000,000,000 Tibo/s",
                timetoTitle: "Tim√©to - The Time Master ‚è≥",
                timetoDescription: "Generates 10,000,000,000 Tibo/s",
                // Secondary Text
                countText: (count) => `Owned: ${count}`,
                costText: (count) => `${formatScore(count)} Tibos`,
                purchasedText: "Purchased",
                // NOUVEAU: Textes de Sauvegarde/Restauration
                saveButton: "Download Save (.tibo)",
                loadButton: "Load Save (.tibo)",
                saveSuccess: "Save file successfully downloaded!",
                loadSuccess: "Game successfully restored from file!",
                loadCorrupted: "Error: The save file is corrupted or invalid.",
                loadFileError: "Error reading the file.",
                fileTypeWrong: "Error: Please select a Tibo Clicker save file (.tibo).",
                maxCritChanceReached: "Max Chance Reached (100%)" 
            },
            es: {
                 // General
                langLabel: "üåê", 
                mainTitle: "Tibo Clicker - ¬°La Verdadera Transformaci√≥n! üí™",
                musicLabel: "M√∫sica", 
                tibosOwnedLabel: "Tibos Pose√≠dos:",
                clickPowerDisplay: (power) => `Poder de Clic: ${formatScore(power)} Tibo${power > 1 ? 's' : ''}`,
                tpsDisplay: (tps) => `Tibos Por Segundo (TPS): ${tps > 1000 ? tps.toFixed(1) : tps.toFixed(0)}`,
                // NOUVEAU: Affichage Critiques
                // MODIFICATION : Utilise critChancePerUpgrade pour la description traduite
                critStatsDisplay: (chance, power) => `Transfo' Cr√≠tica : ${chance.toFixed(1)}% (x${power.toFixed(0)})`,
                upgradesTitle: "Mejoras",
                // Upgrades Multiplicadores (Compra √önica)
                mindsetTitle: "Implementaci√≥n del \"Mindset\"",
                mindsetDescription: "A√±ade +1 TPC base (Compra √önica)",
                ultrasaleTitle: "Tibo Ultra Sucio üí•",
                ultrasaleDescription: "A√±ade +3 TPC base (Compra √önica)",
                cheatmealTitle: "La Comida Trampa Definitiva üçï",
                cheatmealDescription: "A√±ade +6 TPC base (Compra √önica)",
                // NOUVEAU
                godmodeTitle: "La Transfo Divina ‚ö°",
                godmodeDescription: "Multiplica todos los clics por 5000 (Compra √önica)",

                // MODIFICACION: Description avec 0.5%
                critChanceTitle: "Probabilidad de Transfo' Cr√≠tica üìà",
                critChanceDescription: `Aumenta la probabilidad de boost en ${critChancePerUpgrade.toFixed(1)}%`,
                critPowerTitle: "Poder de Transfo' Cr√≠tica üî•",
                critPowerDescription: "Aumenta el multiplicador de boost en x2 (base x2)",
                // Upgrades Repetibles
                proteinesTitle: "Desbloqueo de Prote√≠nas",
                proteinesDescription: "A√±ade +5 Tibos por Clic",
                megaProteinTitle: "Paquete de Entrenamiento Masivo",
                megaProteinDescription: "A√±ade +30 TPC base por compra",
                objectiveCurrencyName: "Puntos de Objetivo",
                objectivesTitle: "Objetivos",
                objective_clicks_100_title: "Clicker Novato",
                objective_clicks_100_desc: "Haz 100 clics",
                objective_score_1000_title: "Tibos Principiante",
                objective_score_1000_desc: "Alcanza 1,000 Tibos",
                objective_first_buy_title: "Primera Compra",
                objective_first_buy_desc: "Compra tu primera mejora",
                objective_reward_received: "Recompensa recibida: +",
                shop_perm_click_x2_title: "Clic x2 Permanente",
                shop_perm_click_x2_desc: "Duplica tus Tibos por clic para siempre (acumulable)",
                shop_temp_click_x2h_title: "Clic x2 (1h)",
                shop_temp_click_x2h_desc: "Duplica tus Tibos por clic durante 1 hora",
                shop_price_reduce_title: "Reducci√≥n de Precio",
                shop_price_reduce_desc: "Reduce el precio de las mejoras en 5% (acumulable)",
                notEnoughObjectivePoints: "No tienes suficientes Puntos de Objetivo",
                timed_clicks_title: "Marat√≥n de Clics",
                timed_clicks_desc: (target, dur) => `Haz ${target} clics en ${dur} segundos`,
                buy_upgrade_title: "Comprar Mejora Espec√≠fica",
                buy_upgrade_desc: (target, upg) => `Compra ${target}x la mejora ${upg}`,
                tps_title: "Alcanza TPS",
                tps_desc: (target) => `Alcanza ${formatScore(target)} Tibos/s`,
                crits_title: "Maestro de Crit",
                crits_desc: (target) => `Obt√©n ${target} Transfo' Cr√≠ticas`,
                alessioTitle: "Alessiode - Entrenador Personal üèãÔ∏è",
                alessioDescription: "Genera 1 Tibo/s",
                justineTitle: "Justine - Community Manager üì∏",
                justineDescription: "Genera 10 Tibo/s",
                patatesTitle: "La F√°brica C√≥smica de Patatas Dulces üç†üöÄ",
                patatesDescription: "Genera 150 Tibo/s",
                nogodeTitle: "Nogode - El Disruptor Oscuro üñ§",
                nogodeDescription: "Genera 500 Tibo/s",
                sachatteTitle: "Sachatte - La Exploradora M√≠stica ‚ú®",
                sachatteDescription: "Genera 2,000 Tibo/s",
                milodesTitle: "Milodes - El Movilizador Instant√°neo üöÄ",
                milodesDescription: "Genera 10,000 Tibo/s",
                thomasTitle: "Thomas - El Arquitecto de Recursos üí∞",
                thomasDescription: "Genera 50,000 Tibo/s",
                lenaikTitle: "Lenaik - La Gardiana Hiperprotectora üõ°Ô∏è",
                lenaikDescription: "Genera 200,000 Tibo/s",
                rodriguesTitle: "Rodrigues - El Bast√≥n del Peregrino üí´",
                rodriguesDescription: "Genera 1,000,000 Tibo/s",
                minotaureTitle: "Minotauro - ¬øQu√© quieres que te haga? üêÇ",
                minotaureDescription: "El Minotauro de Creta. Genera 5,000,000 Tibo/s",
                boomfredTitle: "BoomFred - El GOAT del saxo y Glazunov üé∑",
                boomfredDescription: "Genera 25,000,000 Tibo/s",
                // NEW
                tomasiTitle: "Tomasi - La Melod√≠a Divina üéµ",
                tomasiDescription: "Genera 150,000,000 Tibo/s",
                boubouTitle: "Boubou - Bienvenido a casa hermano ü§ù",
                boubouDescription: "Genera 200,000,000,000 Tibo/s",
                spergabmakerTitle: "SperGabMaker - El Alquimista Supremo üß¨",
                spergabmakerDescription: "Genera 1,000,000,000 Tibo/s",
                timetoTitle: "Tim√©to - El Maestro del Tiempo ‚è≥",
                timetoDescription: "Genera 10,000,000,000 Tibo/s",
                // Secondary Text
                countText: (count) => `Pose√≠do: ${count}`,
                costText: (count) => `${formatScore(count)} Tibos`,
                purchasedText: "Comprado",
                // NOUVEAU: Textes de Sauvegarde/Restauration
                saveButton: "Descargar Guardado (.tibo)",
                loadButton: "Cargar Guardado (.tibo)",
                saveSuccess: "¬°Archivo de guardado descargado exitosamente!",
                loadSuccess: "¬°Juego restaurado exitosamente desde el archivo!",
                loadCorrupted: "Error: El archivo de guardado est√° corrupto o es inv√°lido.",
                loadFileError: "Error al leer el archivo.",
                fileTypeWrong: "Error: Por favor, seleccione un archivo de guardado de Tibo Clicker (.tibo).",
                maxCritChanceReached: "Probabilidad M√°x Alcanzada (100%)" 
            }
        };

        // --- Configuration de la Playlist ---
        let currentTrackIndex = 0;
        const backgroundMusic = document.getElementById('background-music');

        // PLAYLIST MISE √Ä JOUR SELON LA DEMANDE DE L'UTILISATEUR
        const playlist = [
            { url: 'damn-gabin.mp3', title: 'Damn (Gabin)' },
            { url: 'Motivation-Gabin.mp3', title: 'Motivation (Gabin)' }, 
            { url: 'BoubouMax-Gabin.mp3', title: 'BoubouMax (Gabin)' },
            { url: 'Oddloop-Frederic.mp3', title: 'Oddloop (Frederic)' },
            { url: 'Ballade-Tomasi.mp3', title: 'Ballade (Tomasi)' },
            { url: 'Concerto-Glazunov.mp3', title: 'Concerto (Glazunov)' },
            { url: 'Tableaux_de_Provences-Paule_Maurice.mp3', title: 'Tableaux de Provences (Maurice)' }
        ];

        // --- Fonctions de Musique ---

        function loadTrack(index) {
            backgroundMusic.src = playlist[index].url;
            document.getElementById('current-track-title').textContent = playlist[index].title;
            backgroundMusic.load(); // Charge la nouvelle source
        }

        function playMusic() {
            // Tente de jouer, utilise catch pour g√©rer les erreurs de lecture automatique
            backgroundMusic.play().catch(error => {
                console.warn("La lecture automatique a √©t√© bloqu√©e. Le clic de l'utilisateur la relancera.");
            });
        }

        function toggleMusic() {
            if (backgroundMusic.paused) {
                playMusic();
            } else {
                backgroundMusic.pause();
            }
        }

        function nextTrack() {
            currentTrackIndex = (currentTrackIndex + 1) % playlist.length;
            loadTrack(currentTrackIndex);
            playMusic();
        }

        // √âv√©nement pour passer √† la piste suivante √† la fin de la piste actuelle
        backgroundMusic.addEventListener('ended', nextTrack);

        // --- Fonctions de Traduction (Language Functions) ---

        /**
         * Change la langue et met √† jour l'UI. 
         * @param {string} lang Le code de langue ('fr', 'en', 'es').
         * @param {boolean} updateSave Indique si la pr√©f√©rence doit √™tre sauvegard√©e (false pour le chargement initial).
         */
        function setLanguage(lang, updateSave = true) {
            if (!translations[lang]) return;
            currentLang = lang;
            document.getElementById('language-selector').value = lang;
            
            // Mise √† jour des boutons de Sauvegarde/Restauration
            document.getElementById('save-btn').textContent = translations[currentLang].saveButton;
            document.getElementById('load-btn').textContent = translations[currentLang].loadButton;

            // On met √† jour l'UI UNIQUEMENT ici. Si cette fonction est appel√©e apr√®s
            // le chargement des donn√©es, tout sera √† jour.
            updateUI(); 
            
            if (updateSave) {
                 saveLanguage();
            }
        }

        function updateUI() {
            const t = translations[currentLang];

            // Mise √† jour des textes statiques
            document.getElementById('lang-label').textContent = t.langLabel;
            document.getElementById('main-title').textContent = t.mainTitle;
            document.getElementById('music-label').textContent = t.musicLabel;
            document.getElementById('tibos-owned-label').textContent = t.tibosOwnedLabel;
            document.getElementById('upgrades-title').textContent = t.upgradesTitle;

            // Mise √† jour des statistiques dynamiques
            updateScoreDisplay(); 
            updateTPSDisplay();
            updateCritStatsDisplay(); // NOUVEAU
            updateObjectiveCurrencyDisplay(); // NOUVEAU

            // Mise √† jour de tous les boutons d'am√©lioration
            upgradeButtons.forEach(button => {
                const upgradeKey = button.getAttribute('data-upgrade-key');
                // L'attribut data-count DOIT √™tre √† jour suite √† loadGame
                const count = parseInt(button.getAttribute('data-count') || 0); 
                const isPurchased = button.getAttribute('data-purchased') === 'true';

                if (upgradeKey) {
                    const titleElement = button.querySelector('.upgrade-title');
                    const descElement = button.querySelector('.upgrade-description');
                    // On utilise le s√©lecteur de classe pour trouver l'√©l√©ment du compteur
                    const countElement = button.querySelector('.upgrade-count'); 
                    const costElement = button.querySelector('.upgrade-cost');
                    
                    const cost = calculateCost(button);

                    // Mise √† jour des textes de titre/description
                    if (titleElement) titleElement.textContent = t[`${upgradeKey}Title`];
                    
                    // Gestion sp√©ciale de la description de chance critique
                    if (button.id === 'upgrade-crit-chance') {
                        // Utilise la fonction de traduction pour la description mise √† jour
                        if (descElement) descElement.textContent = t[`${upgradeKey}Description`];
                    } else if (descElement) {
                        // Pour les autres descriptions
                        descElement.textContent = t[`${upgradeKey}Description`];
                    }
                    
                    if (costElement) {
                         if (isPurchased && button.hasAttribute('data-max-once')) {
                            // C'est un achat unique MAX√â. Le bouton doit dispara√Ætre, mais on met le texte au cas o√π il serait forc√©.
                            costElement.textContent = `‚úÖ ${t.purchasedText}`;
                            button.disabled = true; // Reste d√©sactiv√©
                        } else if (button.id === 'upgrade-crit-chance' && totalCritChance >= MAX_CRIT_CHANCE) {
                            costElement.textContent = t.maxCritChanceReached;
                            button.disabled = true; // Reste d√©sactiv√©
                        } else {
                            // Le co√ªt est format√©, car il peut √™tre grand
                            costElement.textContent = t.costText(cost);
                        }
                    }

                    // *** POINT CL√â : SYNCHRONISATION DU COMPTEUR VISUEL ***
                    if (countElement) {
                        if (!button.hasAttribute('data-max-once') && totalCritChance < MAX_CRIT_CHANCE) {
                           // Lit le data-count qui a √©t√© restaur√© dans loadGame
                           countElement.textContent = t.countText(count); 
                           countElement.style.display = 'block';
                        } else {
                           countElement.style.display = 'none';
                        }
                    }
                    
                    // G√®re le texte affich√© quand on a atteint le maximum de chance critique
                    if (button.id === 'upgrade-crit-chance' && totalCritChance >= MAX_CRIT_CHANCE) {
                         // Affiche un message sp√©cial si le max 100% est atteint
                         if (descElement) descElement.textContent = t.maxCritChanceReached;
                    }
                }
            });
            checkUpgradeCosts(); // V√©rifie l'√©tat disabled/enabled
            updateUpgradeVisibility(); // NOUVEAU: G√®re la visibilit√© apr√®s la mise √† jour des stats
            updateObjectivesUI(); // Met √† jour le panneau d'objectifs
        }
        
        // --- Fonctions Utilitaire de Score ---

        // Formatage du score pour afficher K, M, B...
        function formatScore(num) {
            if (num < 1000) return Math.floor(num).toString();
            
            const suffixes = ["K", "M", "B", "T", "Qa", "Qi", "Sx", "Sp", "Oc", "No", "Dc"];
            const exp = Math.floor(Math.log(num) / Math.log(1000));
            const suffix = suffixes[exp - 1];
            const formatted = (num / Math.pow(1000, exp)).toFixed(2);
            
            // Supprimer le .00 si c'est un entier
            return formatted.endsWith('.00') ? formatted.slice(0, -3) + suffix : formatted + suffix;
        }

        function updateScoreDisplay() {
            scoreDisplay.textContent = formatScore(score);
            const t = translations[currentLang];
            clickPowerDisplay.textContent = t.clickPowerDisplay(clickPower);
        }

        function updateTPSDisplay() {
            const t = translations[currentLang];
            const tpsValue = tps > 1000 ? tps.toFixed(1) : tps.toFixed(0); 
            tpsDisplay.textContent = t.tpsDisplay(parseFloat(tpsValue));
        }
        
        // NOUVEAU: Mise √† jour de l'affichage des stats critiques
        function updateCritStatsDisplay() {
             const t = translations[currentLang];
             // La chance critique ne doit jamais √™tre affich√©e au-dessus de 100%
             const displayChance = Math.min(totalCritChance, MAX_CRIT_CHANCE); 
             critStatsDisplay.textContent = t.critStatsDisplay(displayChance, totalCritPower);
        }

        // --- Fonctions pour les Objectifs et la nouvelle monnaie ---
        function updateObjectiveCurrencyDisplay() {
            const t = translations[currentLang];
            if (objectiveCurrencyDisplay) {
                objectiveCurrencyDisplay.textContent = `${t.objectiveCurrencyName} : ${formatScore(objectiveCurrency)}`;
            }
        }

        // D√©finition des objectifs (statique, peut √™tre √©tendue)
        const objectives = [
            { id: 'obj_clicks_100', titleKey: 'objective_clicks_100_title', descKey: 'objective_clicks_100_desc', type: 'clicks', target: 100, progress: 0, completed: false, reward: 10 },
            { id: 'obj_score_1000', titleKey: 'objective_score_1000_title', descKey: 'objective_score_1000_desc', type: 'score', target: 1000, progress: 0, completed: false, reward: 20 },
            { id: 'obj_first_buy', titleKey: 'objective_first_buy_title', descKey: 'objective_first_buy_desc', type: 'purchases', target: 1, progress: 0, completed: false, reward: 15 }
        ];

        function updateObjectivesUI() {
            const t = translations[currentLang];
            const list = document.getElementById('objectives-list');
            if (!list) return;
            list.innerHTML = '';

            // Si aucun objectif actif, on en g√©n√®re un par d√©faut pour que la zone
            // ne reste pas vide (utile quand l'utilisateur a tout compl√©t√© ou
            // lors d'un restore o√π tous √©taient marqu√©s compl√©t√©s).
            ensureActiveObjectives();

            // Affiche seulement les objectifs non compl√©t√©s (les compl√©t√©s disparaissent)
            const active = objectives.filter(o => !o.completed);
            active.forEach(obj => {
                // Calculer la progression en temps r√©el √† partir des compteurs globaux
                let progressValue = 0;
                if (obj.type === 'score') {
                    progressValue = Math.floor(score);
                } else if (obj.type === 'clicks') {
                    progressValue = totalClicks;
                } else if (obj.type === 'purchases') {
                    progressValue = totalPurchases;
                } else if (obj.type === 'timed_clicks') {
                    // Recalculer les clics r√©cents dans la fen√™tre (m√™me logique que checkObjectives)
                    const now = Date.now();
                    const windowStart = now - ((obj.durationSec || 60) * 1000);
                    progressValue = clickTimestamps.filter(ts => ts >= windowStart).length;
                } else if (obj.type === 'buy_upgrade') {
                    const button = document.getElementById(obj.upgradeId);
                    if (button) {
                        if (button.hasAttribute('data-count')) {
                            progressValue = parseInt(button.getAttribute('data-count') || 0);
                        } else {
                            progressValue = (button.getAttribute('data-purchased') === 'true') ? 1 : 0;
                        }
                    } else {
                        progressValue = obj.progress || 0;
                    }
                } else if (obj.type === 'tps') {
                    progressValue = Math.floor(tps);
                } else if (obj.type === 'crits') {
                    progressValue = totalCrits;
                } else {
                    // Fallback: utiliser la valeur stock√©e si disponible
                    progressValue = obj.progress || 0;
                }

                // Met √† jour la propri√©t√© progress pour la persistance si besoin
                obj.progress = progressValue;

                const item = document.createElement('div');
                item.style.padding = '6px 8px';
                item.style.border = '1px solid #3a3a3a';
                item.style.borderRadius = '6px';
                item.style.marginBottom = '6px';
                item.style.background = '#262626';

                const title = document.createElement('div');
                title.style.color = '#ffcc00';
                title.style.fontWeight = 'bold';
                // Title can be a direct string or a translation key
                let titleText = '';
                if (obj.title) titleText = obj.title;
                else if (obj.titleKey) {
                    const v = t[obj.titleKey];
                    titleText = (typeof v === 'function') ? v(...(obj.titleParams || [])) : v || '';
                }
                title.textContent = titleText;

                const desc = document.createElement('div');
                desc.style.fontSize = '0.9em';
                desc.style.color = '#ccc';
                let descText = '';
                if (obj.desc) descText = obj.desc;
                else if (obj.descKey) {
                    const dv = t[obj.descKey];
                    descText = (typeof dv === 'function') ? dv(...(obj.descParams || [])) : dv || '';
                }
                desc.textContent = descText;

                const progress = document.createElement('div');
                progress.style.fontSize = '0.85em';
                progress.style.color = '#9fbfbf';
                const progText = obj.type === 'score' ? `${formatScore(progressValue)} / ${formatScore(obj.target)}` : `${progressValue} / ${obj.target}`;
                progress.textContent = `Progress: ${progText}`;

                item.appendChild(title);
                item.appendChild(desc);
                item.appendChild(progress);

                list.appendChild(item);
            });
        }

        // Ensure there's at least one active objective to display
        function ensureActiveObjectives() {
            const activeCount = objectives.filter(o => !o.completed).length;
            if (activeCount === 0) {
                const defaultObj = {
                    id: 'obj_default_' + Date.now(),
                    titleKey: 'objective_clicks_100_title',
                    descKey: 'objective_clicks_100_desc',
                    type: 'clicks',
                    target: 100,
                    progress: 0,
                    completed: false,
                    reward: 10
                };
                objectives.push(defaultObj);
            }
        }

        // V√©rifie les objectifs et r√©compense automatiquement
        function checkObjectives() {
            const t = translations[currentLang];
            objectives.forEach(obj => {
                if (obj.completed) return;

                // Evaluate objective progress for different objective types
                if (obj.type === 'clicks' && totalClicks >= obj.target) {
                    obj.completed = true;
                } else if (obj.type === 'score' && score >= obj.target) {
                    obj.completed = true;
                } else if (obj.type === 'purchases' && totalPurchases >= obj.target) {
                    obj.completed = true;
                } else if (obj.type === 'timed_clicks') {
                    // Count recent clicks within duration
                    const now = Date.now();
                    const windowStart = now - (obj.durationSec * 1000);
                    const recent = clickTimestamps.filter(ts => ts >= windowStart).length;
                    obj.progress = recent;
                    if (recent >= obj.target) obj.completed = true;
                } else if (obj.type === 'buy_upgrade') {
                    const button = document.getElementById(obj.upgradeId);
                    let count = 0;
                    if (button) {
                        if (button.hasAttribute('data-count')) {
                            count = parseInt(button.getAttribute('data-count') || 0);
                        } else {
                            // Achat unique : consid√©rer 1 si data-purchased === true
                            count = (button.getAttribute('data-purchased') === 'true') ? 1 : 0;
                        }
                    }
                    obj.progress = count;
                    if (count >= obj.target) obj.completed = true;
                } else if (obj.type === 'tps') {
                    obj.progress = tps;
                    if (tps >= obj.target) obj.completed = true;
                } else if (obj.type === 'crits') {
                    obj.progress = totalCrits;
                    if (totalCrits >= obj.target) obj.completed = true;
                }

                if (obj.completed) {
                    // Reward once
                    objectiveCurrency += obj.reward;
                    showStatusMessage(`${t.objective_reward_received}${obj.reward} ${t.objectiveCurrencyName}`, false);
                    // Generate a new, harder objective based on this one
                    generateNextObjective(obj);
                }
            });
            updateObjectiveCurrencyDisplay();
            updateObjectivesUI();
        }

        // G√©n√®re l'objectif suivant avec plusieurs templates plus complexes
        function generateNextObjective(prevObj) {
            // Helpers pour arrondir et clamp
            function roundToMultiple(value, multiple) {
                return Math.max(multiple, Math.round(value / multiple) * multiple);
            }
            function clamp(value, min, max) {
                return Math.max(min, Math.min(max, value));
            }

            // Choisir un template al√©atoire (diff√©rent du type pr√©c√©dent si possible)
            const templates = ['clicks','score','purchases','timed_clicks','buy_upgrade','tps','crits'];
            // Essayer d'√©viter le m√™me type
            const choices = templates.filter(t => t !== prevObj.type);
            const pick = choices[Math.floor(Math.random() * choices.length)];

            const baseTarget = prevObj.target || 10;
            let newObj = null;
            const t = translations[currentLang];

            if (pick === 'clicks') {
                let rawTarget = Math.ceil(baseTarget * 2);
                let target = roundToMultiple(rawTarget, 50);
                target = clamp(target, 50, 5000);
                let reward = Math.ceil((prevObj.reward || 5) * 1.5);
                reward = Math.max(5, Math.round(reward / 5) * 5);
                newObj = { type: 'clicks', target: target, reward: reward, titleKey: 'objective_clicks_100_title', descKey: 'objective_clicks_100_desc' };
            } else if (pick === 'score') {
                let rawTarget = Math.ceil((prevObj.target || 1000) * 2);
                let target = roundToMultiple(rawTarget, 50);
                target = clamp(target, 100, 5000000);
                let reward = Math.ceil((prevObj.reward || 10) * 1.6);
                reward = Math.max(5, Math.round(reward / 5) * 5);
                newObj = { type: 'score', target: target, reward: reward, titleKey: 'objective_score_1000_title', descKey: 'objective_score_1000_desc' };
            } else if (pick === 'purchases') {
                let rawTarget = Math.ceil((prevObj.target || 1) * 2);
                let target = clamp(rawTarget, 1, 10); // reste petit
                let reward = Math.ceil((prevObj.reward || 5) * 1.4);
                reward = Math.max(5, Math.round(reward / 5) * 5);
                newObj = { type: 'purchases', target: target, reward: reward, titleKey: 'objective_first_buy_title', descKey: 'objective_first_buy_desc' };
            } else if (pick === 'timed_clicks') {
                let rawTarget = Math.ceil((prevObj.target || 50) * 2);
                let target = roundToMultiple(rawTarget, 50);
                target = clamp(target, 50, 2000);
                const dur = 60; // 60 seconds window
                let reward = Math.ceil((prevObj.reward || 8) * 1.6);
                reward = Math.max(5, Math.round(reward / 5) * 5);
                newObj = { type: 'timed_clicks', target: target, durationSec: dur, reward: reward, titleKey: 'timed_clicks_title', descKey: 'timed_clicks_desc', descParams: [target, dur] };
            } else if (pick === 'buy_upgrade') {
                // Choisir un upgrade al√©atoire parmi ceux existants (√©viter les nulls)
                const availBtns = upgradeButtons.filter(b => b && b.id);
                const upgBtn = availBtns.length ? availBtns[Math.floor(Math.random() * availBtns.length)] : document.getElementById('upgrade-addition');
                const upg = upgBtn ? upgBtn.id : 'upgrade-addition';

                // D√©terminer si l'upgrade est r√©p√©table (poss√®de data-count)
                let target;
                if (upgBtn && upgBtn.hasAttribute('data-count')) {
                    // Limitons les objectifs d'achat √† 10 au maximum
                    target = Math.min(10, Math.max(1, Math.ceil((prevObj.target || 1) * 2)));
                } else {
                    // Pour les achats uniques, cible = 1
                    target = 1;
                }

                // R√©compense li√©e au prix de l'item : plus l'item est cher, plus la r√©compense
                const baseCost = upgBtn ? parseInt(upgBtn.getAttribute('data-base-cost') || upgBtn.getAttribute('data-cost') || 0) : 0;
                const costBasedReward = Math.max(1, Math.ceil(Math.log10(baseCost + 1) * 5));
                const scaledReward = Math.ceil((prevObj.reward || 10) * 1.5);
                const reward = Math.max(1, Math.ceil((costBasedReward + scaledReward) / 2));

                // Pour l'affichage, essayer de r√©cup√©rer un nom lisible de l'upgrade
                let upgName = upg;
                if (upgBtn) {
                    const key = upgBtn.getAttribute('data-upgrade-key');
                    if (key && translations[currentLang] && translations[currentLang][key + 'Title']) {
                        const titleVal = translations[currentLang][key + 'Title'];
                        upgName = (typeof titleVal === 'function') ? titleVal() : titleVal;
                    } else {
                        const titleEl = upgBtn.querySelector('.upgrade-title');
                        if (titleEl) upgName = titleEl.textContent;
                    }
                }

                newObj = { type: 'buy_upgrade', upgradeId: upg, target: target, reward: reward, titleKey: 'buy_upgrade_title', descKey: 'buy_upgrade_desc', descParams: [target, upgName] };
            } else if (pick === 'tps') {
                let rawTarget = Math.ceil((prevObj.target || 10) * 2);
                let target = roundToMultiple(rawTarget, 50);
                target = clamp(target, 1, 1000000);
                let reward = Math.ceil((prevObj.reward || 10) * 1.6);
                reward = Math.max(5, Math.round(reward / 5) * 5);
                newObj = { type: 'tps', target: target, reward: reward, titleKey: 'tps_title', descKey: 'tps_desc', descParams: [target] };
            } else if (pick === 'crits') {
                let rawTarget = Math.ceil((prevObj.target || 5) * 2);
                let target = roundToMultiple(rawTarget, 50);
                target = clamp(target, 50, 500);
                let reward = Math.ceil((prevObj.reward || 5) * 1.5);
                reward = Math.max(5, Math.round(reward / 5) * 5);
                newObj = { type: 'crits', target: target, reward: reward, titleKey: 'crits_title', descKey: 'crits_desc', descParams: [target] };
            }

            if (newObj) {
                newObj.id = `${newObj.type}_${Date.now()}`;
                newObj.progress = 0;
                newObj.completed = false;
                objectives.push(newObj);
            }
        }

        // Objective shop definitions and handlers
        const objectiveShopItems = [
            { id: 'shop_perm_click_x2', titleKey: 'shop_perm_click_x2_title', descKey: 'shop_perm_click_x2_desc', cost: 50, growth: 2, type: 'perm_click', bought: 0 },
            { id: 'shop_temp_click_x2h', titleKey: 'shop_temp_click_x2h_title', descKey: 'shop_temp_click_x2h_desc', cost: 20, growth: 1.5, type: 'temp_click', durationSec: 3600, bought: 0 },
            { id: 'shop_price_reduce', titleKey: 'shop_price_reduce_title', descKey: 'shop_price_reduce_desc', cost: 100, growth: 2, type: 'price_reduce', bought: 0 }
        ];

        function updateObjectiveShopUI() {
            const shop = document.getElementById('objective-shop');
            if (!shop) return;
            shop.innerHTML = '';
            const t = translations[currentLang];

            objectiveShopItems.forEach(item => {
                const row = document.createElement('div');
                row.className = 'objective-shop-item';

                const left = document.createElement('div');
                left.innerHTML = `<strong>${t[item.titleKey]}</strong><div style=\"font-size:0.9em;color:#ccc\">${t[item.descKey]}</div>`;

                const right = document.createElement('div');
                const cost = Math.floor(item.cost * Math.pow(item.growth || 1, item.bought));
                const btn = document.createElement('button');
                btn.textContent = `${t.objectiveCurrencyName}: ${formatScore(cost)}`;
                btn.disabled = objectiveCurrency < cost;
                btn.addEventListener('click', () => buyObjectiveShopItem(item.id));

                right.appendChild(btn);
                row.appendChild(left);
                row.appendChild(right);
                shop.appendChild(row);
            });
        }

        function buyObjectiveShopItem(itemId) {
            const item = objectiveShopItems.find(i => i.id === itemId);
            if (!item) return;
            const cost = Math.floor(item.cost * Math.pow(item.growth || 1, item.bought));
            if (objectiveCurrency < cost) {
                showStatusMessage(translations[currentLang].notEnoughObjectivePoints || 'Pas assez de Points d\'Objectif', true);
                return;
            }
            objectiveCurrency -= cost;
            item.bought++;

            // Appliquer l'effet
            if (item.type === 'perm_click') {
                objectiveClickMultiplier *= 2; // permanent x2 stackable
            } else if (item.type === 'temp_click') {
                const expiresAt = Date.now() + (item.durationSec * 1000);
                temporaryMultipliers.push({ multiplier: 2, expiresAt: expiresAt });
            } else if (item.type === 'price_reduce') {
                objectivePriceReductionCount++;
            }

            showStatusMessage(`${translations[currentLang].objective_reward_received}${0} ${translations[currentLang].objectiveCurrencyName}`, false);
            updateObjectiveCurrencyDisplay();
            updateObjectiveShopUI();
            saveGame();
        }

        /**
         * Calcule le co√ªt d'une am√©lioration en fonction de son type (unique ou r√©p√©table).
         * @param {HTMLElement} button Le bouton de l'am√©lioration.
         * @returns {number} Le co√ªt actuel de l'am√©lioration.
         */
        function calculateCost(button) {
            const isPurchased = button.getAttribute('data-purchased') === 'true';
            
            if (isPurchased) {
                return parseInt(button.getAttribute('data-cost') || button.getAttribute('data-base-cost'));
            }

            // 1. D√©termine le co√ªt de base
            const baseCost = parseInt(button.getAttribute('data-base-cost') || button.getAttribute('data-cost'));
            const count = parseInt(button.getAttribute('data-count') || 0);
            
            // 2. Si l'am√©lioration n'est PAS r√©p√©table (pas de data-count), retourne le co√ªt de base
            if (!button.hasAttribute('data-count')) {
                return baseCost;
            }
            
            // 3. Logique d'augmentation exponentielle pour les am√©liorations r√©p√©tables
            // Utilise le data-growth sp√©cifi√©, sinon utilise le facteur standard CRIT_GROWTH_FACTOR (1.3)
            const growthFactor = parseFloat(button.getAttribute('data-growth')) || CRIT_GROWTH_FACTOR;

            const calculatedCost = Math.floor(baseCost * Math.pow(growthFactor, count));
            return calculatedCost;
        }


        // --- Logique du Clic (Mise √† jour pour le Mobile) ---

        function handleInteraction(e) {
            // Emp√™che le comportement par d√©faut pour les √©v√©nements tactiles
            // afin d'√©viter le zoom, le scroll ou les "clics fant√¥mes"
            if (e.type === 'touchstart') {
                e.preventDefault(); 
            }
            
            // Gestion de l'animation tactile
            tiboImage.classList.add('active-touch');
            setTimeout(() => tiboImage.classList.remove('active-touch'), 50);

            // Calcul du score
            // Compteur total de clics pour les objectifs
            totalClicks++;
            // Stocke le timestamp pour les objectifs temporels (garder seulement 2 heures)
            const now = Date.now();
            clickTimestamps.push(now);
            const twoHours = 2 * 3600 * 1000;
            clickTimestamps = clickTimestamps.filter(ts => now - ts <= twoHours);

            let scoreToAdd = clickPower;
            let isCrit = false;

            const actualCritChance = Math.min(totalCritChance, MAX_CRIT_CHANCE) / 100;
            
            if (Math.random() < actualCritChance) { 
                 scoreToAdd *= totalCritPower;
                 isCrit = true;
            }

            score += scoreToAdd;
              if (isCrit) totalCrits++;
            updateScoreDisplay();
            
            // D√©terminer les coordonn√©es (Souris ou Touch)
            let clientX, clientY;
            if (e.type === 'touchstart' && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }

            // Animation du texte flottant
            createFloatingText(scoreToAdd, clientX, clientY, isCrit);
            checkUpgradeCosts();
            checkUpgradeVisibility();

            // V√©rifier les objectifs imm√©diatement apr√®s un clic
            checkObjectives();

            saveGame(); 
        }

        // On √©coute 'touchstart' en priorit√© pour la r√©activit√© mobile
        // { passive: false } est crucial pour pouvoir utiliser preventDefault()
        tiboImage.addEventListener('touchstart', handleInteraction, { passive: false });
        
        // On garde 'mousedown' pour PC (plus r√©actif que 'click')
        tiboImage.addEventListener('mousedown', handleInteraction);

        function createFloatingText(amount, x, y, isCrit) {
            const text = document.createElement('div');
            text.classList.add('floating-text');
            
            if (isCrit) {
                text.classList.add('crit');
                text.textContent = `CRIT! x${totalCritPower.toFixed(0)}`;
            } else {
                text.textContent = `+${formatScore(amount)}`;
            }
            
            // Positionnement
            const rect = tiboImage.getBoundingClientRect();
            // On calcule le d√©calage pour centrer un peu
            // Mais pour le mobile, on veut que √ßa apparaisse un peu au-dessus du doigt
            const offsetY = isCrit ? -50 : -20; 
            
            text.style.left = `${x}px`; 
            text.style.top = `${y + offsetY}px`;

            // On ajoute au body pour √©viter les probl√®mes de d√©bordement/coupure
            document.body.appendChild(text);

            // Nettoyage apr√®s l'animation
            text.addEventListener('animationend', () => {
                text.remove();
            });
        }

        // --- Logique des Am√©liorations ---

        upgradeButtons.forEach(button => {
            button.addEventListener('click', () => buyUpgrade(button));
        });

        function buyUpgrade(button) {
            const cost = calculateCost(button);
            
            // V√©rifie si le bouton est l'upgrade critique et si on a atteint 100%
            if (button.id === 'upgrade-crit-chance' && totalCritChance >= MAX_CRIT_CHANCE) {
                 showStatusMessage(translations[currentLang].maxCritChanceReached, true);
                 return; 
            }
            
            if (score >= cost) {
                score -= cost;
                
                // Incr√©mente le compteur pour l'achat suivant (seulement si c'est r√©p√©table)
                if (button.hasAttribute('data-count')) {
                    let count = parseInt(button.getAttribute('data-count'));
                    button.setAttribute('data-count', ++count);
                }

                // Incr√©mente le compteur global d'achats (pour les objectifs)
                totalPurchases++;
                
                // Si c'est un achat unique (Mindset, Ultra Sale, Cheat Meal)
                if (button.hasAttribute('data-add-bonus') || button.hasAttribute('data-multiplier')) {
                    button.setAttribute('data-purchased', 'true');
                }
                
                // 2. Recalculer toutes les stats √† partir des attributs des boutons
                recalculateStatsFromUpgrades();

                // 3. Mise √† jour de l'UI et de l'√©tat
                updateUI(); // Met √† jour le texte du bouton et le statut 'disabled' (incluant le count)
                // V√©rifier les objectifs apr√®s un achat (un achat peut d√©clencher une r√©compense)
                checkObjectives();
                saveGame(); // Sauvegarde le jeu apr√®s l'achat
            } else {
                // NE PAS UTILISER alert()
                showStatusMessage(translations[currentLang].notEnoughTibos || "Pas assez de Tibos !", true);
            }
        }
        
        /**
         * NOUVEAU : Recalcule les statistiques globales (clickPower, tps, critChance, critPower) 
         * en parcourant tous les upgrades
         */
        function recalculateStatsFromUpgrades() {
            let totalClickPower = 1; // Base de 1 TPC
            let totalTps = 0;
            let clickMultiplier = 1; // NOUVEAU : Multiplicateur global pour le clic
            
            let critChanceCount = 0;
            let critPowerCount = 0;

            upgradeButtons.forEach(button => {
                const count = parseInt(button.getAttribute('data-count') || 0);
                const isPurchased = button.getAttribute('data-purchased') === 'true';

                // 1. Clics uniques (Bonus Additif)
                if (button.hasAttribute('data-add-bonus') && isPurchased) {
                    totalClickPower += parseInt(button.getAttribute('data-add-bonus'));
                } 
                // NOUVEAU : 1.5 Clics Multiplicateurs (x5000)
                else if (button.hasAttribute('data-multiplier') && isPurchased) {
                     clickMultiplier *= parseInt(button.getAttribute('data-multiplier'));
                }
                // 2. Clics r√©p√©tables (Prot√©ines et autres am√©liorations avec data-addition)
                else if (button.hasAttribute('data-addition')) {
                    const addition = parseInt(button.getAttribute('data-addition')) || 0;
                    totalClickPower += addition * count;
                }
                // 3. Passifs (TPS, incluant le Minotaure et BoomFred)
                else if (button.hasAttribute('data-tps')) {
                    const passiveTps = parseInt(button.getAttribute('data-tps'));
                    totalTps += passiveTps * count;
                }
                // 4. Crit Chance
                else if (button.id === 'upgrade-crit-chance') {
                    critChanceCount = count;
                }
                // 5. Crit Power
                else if (button.id === 'upgrade-crit-power') {
                    critPowerCount = count;
                }
            });

            // Mise √† jour des variables globales
            // Applique le multiplicateur √† la puissance totale
            clickPower = totalClickPower * clickMultiplier;
            tps = totalTps;
            
            // Mise √† jour des stats critiques
            // totalCritChance commence √† 0 (baseCritChance) et ajoute 0.5% par achat
            totalCritChance = baseCritChance + (critChanceCount * critChancePerUpgrade);
            totalCritPower = 2 + (critPowerCount * critPowerPerUpgrade);
        }


        function checkUpgradeCosts() {
            upgradeButtons.forEach(button => {
                const cost = calculateCost(button);
                const isPurchased = button.getAttribute('data-purchased') === 'true';
                
                // Mettre √† jour le co√ªt affich√© (si non achet√©)
                const costElement = button.querySelector('.upgrade-cost');
                if (costElement && !isPurchased) {
                     // Utilise la traduction pour formater le co√ªt
                    costElement.textContent = translations[currentLang].costText(cost);
                }
                
                // D√©sactivation si d√©j√† achet√© (pour les achats uniques)
                if (isPurchased && button.hasAttribute('data-max-once')) {
                    button.disabled = true;
                }
                // D√©sactivation si chance max (100%) atteinte pour l'upgrade chance critique
                else if (button.id === 'upgrade-crit-chance' && totalCritChance >= MAX_CRIT_CHANCE) {
                    button.disabled = true;
                    // Le texte du co√ªt est mis √† jour dans updateUI()
                }
                // D√©sactivation si score insuffisant
                else {
                    button.disabled = score < cost;
                }
            });
        }
        
        // Rend visible les upgrades cach√©s une fois le score atteint
        function checkUpgradeVisibility() {
            // Logique pour r√©v√©ler les upgrades uniques
            // Note: On utilise le score actuel (qui est charg√©) pour v√©rifier
            if (score >= 400 && upgrade2_new.classList.contains('hidden')) {
                upgrade2_new.classList.remove('hidden');
                upgrade2_new.style.opacity = 1;
            }
             if (score >= 2500 && upgrade3_new.classList.contains('hidden')) {
                upgrade3_new.classList.remove('hidden');
                upgrade3_new.style.opacity = 1;
            }
            
            // NOUVEAU : Apparition de l'upgrade Divine (√† 500 Milliards pour l'effet de surprise)
            if (score >= 500000000000 && upgradeGod.classList.contains('hidden')) {
                upgradeGod.classList.remove('hidden');
                upgradeGod.style.opacity = 1;
            }
            
            // Assure que les upgrades sont visibles au rechargement si d√©j√† achet√©s ou d√©couverts
            [upgrade2_new, upgrade3_new, upgradeGod].forEach(btn => {
                 if (btn.getAttribute('data-purchased') === 'true' || score >= parseInt(btn.getAttribute('data-cost')) * 0.8) {
                    btn.classList.remove('hidden');
                    btn.style.opacity = 1;
                }
            });
        }
        
        /**
         * NOUVEAU: G√®re l'ajout/retrait de la classe 'hidden-maxed' pour faire dispara√Ætre les upgrades.
         */
        function updateUpgradeVisibility() {
            // 1. Am√©liorations √† Achat Unique (data-max-once="true")
            [upgrade1, upgrade2_new, upgrade3_new, upgradeGod].forEach(button => {
                const isPurchased = button.getAttribute('data-purchased') === 'true';
                
                // Si achet√©, on ajoute la classe hidden-maxed pour masquer compl√®tement
                if (isPurchased) {
                    button.classList.add('hidden-maxed');
                } else {
                    // Si pas achet√©, on g√®re la visibilit√© bas√©e sur le score (classe 'hidden')
                    // et on s'assure que hidden-maxed n'est pas l√†
                    button.classList.remove('hidden-maxed');
                }
            });
            
            // 2. Am√©lioration de Chance Critique (Maximum 100%)
            if (totalCritChance >= MAX_CRIT_CHANCE) {
                critChanceUpgradeBtn.classList.add('hidden-maxed');
            } else {
                critChanceUpgradeBtn.classList.remove('hidden-maxed');
            }
        }


        // --- Logique Passive (Game Loop) ---

        function gameLoop() {
            // V√©rifie si le TPS est > 0 avant d'ajouter le score
            if (tps > 0) {
                // Ajout du TPS (divis√© par le nombre de cycles par seconde, ici 10)
                // L'utilisation de tps / 10 pour un intervalle de 100ms donne tps / seconde
                const addedScore = tps / 10; 
                score += addedScore; 
            }
            
            // Affichage et v√©rification
            updateScoreDisplay();
            updateTPSDisplay(); 
            updateCritStatsDisplay(); // NOUVEAU
            checkUpgradeCosts();
            // Mise √† jour de la visibilit√© des nouveaux upgrades (bas√© sur le score qui monte)
            checkUpgradeVisibility();

            // V√©rifie p√©riodiquement les objectifs
            checkObjectives();

            // Sauvegarde du jeu toutes les 10 secondes (pour ne pas surcharger)
            // Utiliser un drapeau pour ne pas sauvegarder 10 fois par seconde
            const now = Math.floor(performance.now() / 1000);
            if (now % 10 === 0 && !window.hasSavedThisSecond) {
                saveGame();
                window.hasSavedThisSecond = true;
            } else if (now % 10 !== 0) {
                 window.hasSavedThisSecond = false;
            }
        }

        // Ex√©cution de la boucle toutes les 100ms (10 fois par seconde)
        setInterval(gameLoop, 100); 

        // --- Sauvegarde et Chargement (Local Storage) ---

        function saveGame() {
            // Sauvegarde des stats critiques
            // MODIFICATION: Met √† jour l'attribut data-crit-chance-add du bouton
            critChanceUpgradeBtn.setAttribute('data-crit-chance-add', critChancePerUpgrade); 
            critPowerUpgradeBtn.setAttribute('data-crit-power-add', critPowerPerUpgrade);
            
            const saveObject = {
                score: score,
                objectiveCurrency: objectiveCurrency,
                totalClicks: totalClicks,
                totalPurchases: totalPurchases,
                totalCrits: totalCrits,
                objectiveClickMultiplier: objectiveClickMultiplier,
                temporaryMultipliers: temporaryMultipliers,
                objectivePriceReductionCount: objectivePriceReductionCount,
                upgrades: [],
                lang: currentLang
            };

            // Sauvegarde de l'√©tat de chaque bouton
            upgradeButtons.forEach(button => {
                saveObject.upgrades.push({
                    id: button.id,
                    count: parseInt(button.getAttribute('data-count') || 0),
                    purchased: button.getAttribute('data-purchased') === 'true'
                });
            });

            // Sauvegarde de l'√©tat des objectifs
            saveObject.objectives = objectives.map(o => ({ id: o.id, progress: o.progress, completed: !!o.completed }));
            // Sauvegarde de l'√©tat du magasin d'objectifs
            saveObject.objectiveShop = objectiveShopItems.map(i => ({ id: i.id, bought: i.bought }));

            localStorage.setItem(GAME_STORAGE_KEY, JSON.stringify(saveObject));
        }

        /**
         * Charge le jeu en restaurant toutes les donn√©es avant de mettre √† jour l'UI.
         * Cette fonction est appel√©e au d√©marrage et lors d'une restauration par fichier.
         * @param {object|null} loadedSaveObject L'objet de sauvegarde √† charger (si restauration par fichier).
         */
        function loadGame(loadedSaveObject = null) {
            let saveObject;
            
            if (loadedSaveObject) {
                // Chargement √† partir d'un fichier fourni
                saveObject = loadedSaveObject;
            } else {
                // Chargement depuis le Local Storage
                const savedGame = localStorage.getItem(GAME_STORAGE_KEY);
                saveObject = savedGame ? JSON.parse(savedGame) : null;
            }

            const savedLang = localStorage.getItem(LANG_STORAGE_KEY);

            // 1. Initialisation des donn√©es par d√©faut
            score = 0;
            clickPower = 1; 
            tps = 0; 
            
            // 2. Restauration de l'√©tat
            if (saveObject) {
                
                // Restauration du score
                score = saveObject.score || 0;

                // Restauration de l'√©tat des boutons (set des attributs)
                saveObject.upgrades.forEach(savedUpgrade => {
                    const button = document.getElementById(savedUpgrade.id);
                    if (button) {
                        // Assurez-vous que les donn√©es sont des nombres/bool√©ens pour √©viter les erreurs
                        button.setAttribute('data-count', parseInt(savedUpgrade.count || 0));
                        button.setAttribute('data-purchased', (savedUpgrade.purchased === true || savedUpgrade.purchased === 'true').toString());
                    }
                });
                
                // Restauration de la langue
                if (saveObject.lang) {
                    currentLang = saveObject.lang;
                }
                // Restauration de la monnaie d'objectifs et compteurs
                objectiveCurrency = parseInt(saveObject.objectiveCurrency || 0);
                totalClicks = parseInt(saveObject.totalClicks || 0);
                totalPurchases = parseInt(saveObject.totalPurchases || 0);
                // Restauration des stats li√©es aux objectifs
                objectiveClickMultiplier = parseFloat(saveObject.objectiveClickMultiplier || 1);
                temporaryMultipliers = Array.isArray(saveObject.temporaryMultipliers) ? saveObject.temporaryMultipliers.filter(tm => tm && tm.expiresAt && tm.expiresAt > Date.now()) : [];
                objectivePriceReductionCount = parseInt(saveObject.objectivePriceReductionCount || 0);
                totalCrits = parseInt(saveObject.totalCrits || 0);

                // Restauration de l'√©tat du magasin d'objectifs
                if (Array.isArray(saveObject.objectiveShop)) {
                    saveObject.objectiveShop.forEach(si => {
                        const local = objectiveShopItems.find(it => it.id === si.id);
                        if (local) local.bought = parseInt(si.bought || 0);
                    });
                }

                // Restauration des objectifs (si fournis)
                if (Array.isArray(saveObject.objectives)) {
                    saveObject.objectives.forEach(savedObj => {
                        const obj = objectives.find(o => o.id === savedObj.id);
                        if (obj) {
                            obj.progress = savedObj.progress || 0;
                            obj.completed = savedObj.completed === true;
                        }
                    });
                }
            }
            
            // 3. Chargement de la Langue (si elle est d√©finie ind√©pendamment de la save)
            if (savedLang) {
                currentLang = savedLang;
            }
            
            // NOUVEAU : Recalculer les stats globales apr√®s avoir appliqu√© les attributs des boutons
            recalculateStatsFromUpgrades();
            
            // V√©rifier imm√©diatement les objectifs (au cas o√π le joueur a d√©j√† rempli des conditions)
            checkObjectives();
            updateObjectiveCurrencyDisplay();
            // 4. Mise √† jour finale et unique de l'interface et de l'√©tat.
            setLanguage(currentLang, false); 
            // Mise √† jour de la visibilit√© initiale, y compris les upgrades cach√©s au max
            updateUpgradeVisibility(); 
        }
        
        function saveLanguage() {
            localStorage.setItem(LANG_STORAGE_KEY, currentLang);
        }
        
        // --- NOUVELLES FONCTIONS : Sauvegarde Manuelle et Restauration par Fichier ---
        
        /**
         * Affiche un message de statut temporaire √† l'utilisateur.
         * @param {string} message Le message √† afficher (traduit).
         * @param {boolean} isError Vrai si c'est une erreur, Faux si c'est un succ√®s.
         */
        function showStatusMessage(message, isError) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';

            // G√©rer les classes de style
            statusDiv.classList.remove('status-success', 'status-error');
            if (isError) {
                statusDiv.classList.add('status-error');
            } else {
                statusDiv.classList.add('status-success');
            }

            // Masquer apr√®s 5 secondes
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        /**
         * T√©l√©charge l'√©tat actuel du jeu dans un fichier .tibo.
         */
        function downloadGameSave() {
            // 1. Assurez-vous que la sauvegarde locale est √† jour avant d'exporter
            saveGame();
            
            // 2. R√©cup√©rer les donn√©es brutes du localStorage
            const dataToSave = localStorage.getItem(GAME_STORAGE_KEY);
            
            if (!dataToSave) {
                 showStatusMessage("Erreur: Aucune donn√©e de jeu √† sauvegarder.", true);
                 return;
            }

            // 3. Cr√©er un Blob (Binary Large Object)
            const blob = new Blob([dataToSave], { type: 'application/json' });
            
            // 4. Cr√©er et cliquer sur un lien de t√©l√©chargement invisible
            const a = document.createElement('a');
            const date = new Date().toISOString().slice(0, 10);
            a.download = `tibo-clicker-save-${date}.tibo`; // Nom du fichier avec extension
            a.href = URL.createObjectURL(blob);
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showStatusMessage(translations[currentLang].saveSuccess, false);
        }

        /**
         * Lit le fichier de sauvegarde et restaure l'√©tat du jeu.
         */
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // 1. V√©rification du type de fichier
            if (!file.name.endsWith('.tibo')) {
                showStatusMessage(translations[currentLang].fileTypeWrong, true);
                event.target.value = ''; // R√©initialiser le champ pour permettre un nouveau chargement
                return;
            }

            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const loadedState = JSON.parse(content);

                    // 2. Validation de base de la structure du fichier
                    // Le Minotaure est un upgrade, il doit faire partie du tableau 'upgrades'
                    if (typeof loadedState.score !== 'number' || !Array.isArray(loadedState.upgrades)) {
                        showStatusMessage(translations[currentLang].loadCorrupted, true);
                        event.target.value = '';
                        return;
                    }

                    // 3. Appliquer la nouvelle sauvegarde (met √† jour les variables globales)
                    loadGame(loadedState); 
                    
                    // 4. Mettre √† jour la sauvegarde locale pour la persistance
                    saveGame(); 

                    showStatusMessage(translations[currentLang].loadSuccess, false);
                    event.target.value = ''; // R√©initialiser le champ
                } catch (error) {
                    showStatusMessage(translations[currentLang].loadFileError, true);
                    console.error("File loading error:", error);
                    event.target.value = '';
                }
            };

            reader.onerror = function() {
                showStatusMessage(translations[currentLang].loadFileError, true);
                event.target.value = '';
            };

            reader.readAsText(file);
        }
        
        // --- Initialisation et √âv√©nements ---

        window.onload = function() {
            // 1. Initialisation de la Musique
            loadTrack(currentTrackIndex); 
            // 2. Chargement du jeu (qui met √† jour l'UI √† la fin et appelle recalculateStatsFromUpgrades)
            loadGame(); 
            
            // 3. √âv√©nements pour la Sauvegarde/Restauration
            document.getElementById('save-btn').addEventListener('click', downloadGameSave);
            
            const fileInput = document.getElementById('file-input');
            document.getElementById('load-btn').addEventListener('click', () => {
                fileInput.click(); // D√©clenche le clic sur l'input de fichier cach√©
            });
            fileInput.addEventListener('change', handleFileUpload);
        };

        // D√©tection du clic sur l'image pour autoriser la lecture audio (contourne l'autoplay block)
        let hasInteracted = false;
        // Utilisez mousedown/touchstart pour initialiser l'audio plus rapidement
        const initAudio = () => {
             if (!hasInteracted) {
                playMusic();
                hasInteracted = true;
            }
        };
        tiboImage.addEventListener('touchstart', initAudio, { passive: true });
        tiboImage.addEventListener('mousedown', initAudio);

    </script>
</body>
</html>
